(()=>{"use strict";class e{constructor(e,o,t,n,r){this.libroDellaCopiaISBN=e.isbn,this.codiceUnivoco=o,this.prezzoCopertina=t,this.prezzoScontato=parseFloat((.5*t).toFixed(2)),this.venditoreID=n.id,this.stato=r}toString(){return`${this.libroDellaCopiaISBN};${this.codiceUnivoco};${this.prezzoCopertina};${this.prezzoScontato};${this.venditoreID};${this.stato}`}}const o=new BroadcastChannel("aggiornamentoDatabase"),t=new WebSocket("ws://192.168.1.2:8081");t.onopen=function(){console.log("aperto il server")},t.onclose=function(){console.log("connessione server chiusa")},t.onerror=function(e){console.log("errore nel webSocket",e)};var n=function(e,o,t,n){return new(t||(t=Promise))((function(r,i){function c(e){try{l(n.next(e))}catch(e){i(e)}}function s(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var o;e.done?r(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(c,s)}l((n=n.apply(e,o||[])).next())}))};let r;const i=document.getElementById("ripristinaCopie");function c(){return n(this,void 0,void 0,(function*(){try{const e=yield function(){return n(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const t=r.transaction("Copie","readonly").objectStore("Copie").getAll();t.onsuccess=()=>{const o=t.result.filter((e=>"E"===e.stato));e(o)},t.onerror=()=>{o(t.error)}}))}))}(),o=document.getElementById("corpoTabellaCopie");o.innerHTML="";for(let t=0;t<e.length;t++){let n=e[t];const i=yield new Promise(((e,o)=>{const t=r.transaction("Libri","readonly").objectStore("Libri").get(n.libroDellaCopiaISBN);t.onsuccess=()=>{t.result?e(t.result):o(new Error("Libro con ISBN non trovato"))},t.onerror=()=>{o(new Error("Database dei libri non reperibile"))}})),c=document.createElement("tr"),s=document.createElement("td"),l=document.createElement("input");l.setAttribute("type","checkbox"),l.setAttribute("class","caselleSelezione"),s.appendChild(l),c.appendChild(l);const a=document.createElement("td");a.textContent=String(n.codiceUnivoco),c.appendChild(a);const d=document.createElement("td");d.textContent=String(i.isbn),c.appendChild(d);const u=document.createElement("td");u.textContent=i.titolo,c.appendChild(u);const p=document.createElement("td");p.textContent=String(n.prezzoCopertina),c.appendChild(p);const m=document.createElement("td");m.textContent=String(n.prezzoScontato),c.appendChild(m),o.appendChild(c)}}catch(e){e instanceof Error&&console.error(e.message)}}))}null==i||i.addEventListener("click",(function(){return n(this,void 0,void 0,(function*(){const i=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==i.length){if(window.confirm("Vuoi ripristinare le copie selezionate?"))try{const s=r.transaction("Copie","readwrite").objectStore("Copie"),l=Array.from(i).map((i=>n(this,void 0,void 0,(function*(){var c,l;const a=i.closest("tr");if(a){const i=null===(l=null===(c=a.cells[0])||void 0===c?void 0:c.textContent)||void 0===l?void 0:l.trim();if(i)return new Promise(((c,l)=>{const a=s.get(Number(i));a.onsuccess=()=>{const d=a.result;if(d){d.stato="D";const i=s.put(d);i.onsuccess=()=>{o.postMessage({store:"Copie"}),function(o){n(this,void 0,void 0,(function*(){let i;if(o instanceof e)i=o;else{const t=o,c=yield function(e){return n(this,void 0,void 0,(function*(){const o=r.transaction("Libri","readonly").objectStore("Libri"),t=yield new Promise(((t,n)=>{const r=o.get(e);r.onsuccess=()=>{r.result?t(r.result):n(new Error("Libro non trovato con ISBN"+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),n(r.error)}}));return t}))}(Number(t.libroDellaCopiaISBN)),s=yield function(e){return n(this,void 0,void 0,(function*(){const o=r.transaction("Venditori","readonly").objectStore("Venditori"),t=yield new Promise(((t,n)=>{const r=o.get(e);r.onsuccess=()=>{r.result?t(r.result):n(new Error("Venditore non trovato con codice fiscale: "+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),n(r.error)}}));return t}))}(Number(t.venditoreID));i=new e(c,Number(t.codiceUnivoco),Number(t.prezzoCopertina),s,t.stato)}t.send("C,"+String(null==i?void 0:i.toString()))}))}(d),c()},i.onerror=()=>{l(new Error("Errore nell'aggiornamento dello stato della copia."))}}else l(new Error(`Copia con ID ${i} non trovata nello store 'Copie'.`))},a.onerror=()=>{l(new Error("Errore nel recupero della copia."))}}))}}))));yield Promise.all(l),window.alert("Copia/e ripristinate correttamente."),yield c()}catch(e){e instanceof Error&&console.error(e.message)}}else window.alert("Seleziona almeno una copia da ripristinare")}))})),t.onopen=function(){console.log("aperto il server")},t.onclose=function(){console.log("connessione server chiusa")},t.onerror=function(e){console.log("errore nel webSocket",e)},o.onmessage=e=>n(void 0,void 0,void 0,(function*(){"Copie"===e.data.store&&(console.log("Aggiornamento ricevuto: ricarico copie eliminate..."),location.reload())})),document.addEventListener("DOMContentLoaded",(()=>n(void 0,void 0,void 0,(function*(){try{r=yield function(){let e=new Promise(((e,o)=>{const t=indexedDB.open("Database",1);t.onerror=()=>{o(t.onerror)},t.onsuccess=()=>{const o=t.result;e(o)}}));return e}(),console.log("Database aperto:",r.name),yield c()}catch(e){console.error(e)}}))))})();