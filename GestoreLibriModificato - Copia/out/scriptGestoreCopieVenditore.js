(()=>{"use strict";class e{constructor(e,o,n,t,r){this.libroDellaCopiaISBN=e.isbn,this.codiceUnivoco=o,this.prezzoCopertina=n,this.prezzoScontato=parseFloat((.5*n).toFixed(2)),this.venditoreID=t.id,this.stato=r}toString(){return`${this.libroDellaCopiaISBN};${this.codiceUnivoco};${this.prezzoCopertina};${this.prezzoScontato};${this.venditoreID};${this.stato}`}}const o=new BroadcastChannel("aggiornamentoDatabase"),n=new WebSocket("ws://192.168.1.9:8082");n.onopen=function(){console.log("aperto il server")},n.onclose=function(){console.log("connessione server chiusa")},n.onerror=function(e){console.log("errore nel webSocket",e)};var t=function(e,o,n,t){return new(n||(n=Promise))((function(r,i){function c(e){try{s(t.next(e))}catch(e){i(e)}}function l(e){try{s(t.throw(e))}catch(e){i(e)}}function s(e){var o;e.done?r(e.value):(o=e.value,o instanceof n?o:new n((function(e){e(o)}))).then(c,l)}s((t=t.apply(e,o||[])).next())}))};let r=document.getElementById("canvaBarcode");const i=new URLSearchParams(window.location.search),c=Number(i.get("venditoreID")),l=i.get("isbn");let s,a,d;const u=document.getElementById("aggiungiCopia");null==u||u.addEventListener("click",E);const p=document.getElementById("popupRegistraCopia"),m=document.getElementById("registraCopia");null==m||m.addEventListener("click",(function(){return t(this,void 0,void 0,(function*(){const n=yield function(){return t(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const n=s.transaction("Copie","readonly").objectStore("Copie").openCursor(null,"prev");n.onsuccess=()=>{const o=n.result;e(o?o.primaryKey:null)},n.onerror=()=>{o(n.error)}}))}))}();let r;if(r=null!==n?n+1:1,""!==h.value)if(null!=d){const n=new e(d,r,parseFloat(h.value),a,"D");d=null,yield function(e){return t(this,void 0,void 0,(function*(){const n=s.transaction("Copie","readwrite").objectStore("Copie").add(e);n.onsuccess=()=>{h.value="",g.value="",i.delete("isbn"),i.delete("prezzoCopertina"),o.postMessage({store:"Copie"}),b(e),L(B(e.codiceUnivoco,a.id),`${e.codiceUnivoco}_copiaID`);const n=`${window.location.pathname}?${i.toString()}`;window.history.replaceState({},"",n),z(),S()},n.onerror=()=>{console.error("Copia giÃ  presente")}}))}(n)}else window.alert("Scegliere un libro dalla libreria da associarte alla copia che si vuole registrare");else window.alert("Inserire il prezzo di copertina per procedere con la registrazione")}))}));const v=document.getElementById("chiudiPopup");null==v||v.addEventListener("click",S);const f=document.getElementById("scegliLibro");null==f||f.addEventListener("click",(function(){const e=new URLSearchParams;e.set("venditoreID",String(a.id));const o=h.value;e.set("prezzoCopertina",o),window.location.href=`selezionaLibro.html?${e.toString()}`}));const h=document.getElementById("prezzoCopertina"),g=document.getElementById("titoloLibro"),w=document.getElementById("eliminaCopie");null==w||w.addEventListener("click",(function(){return t(this,void 0,void 0,(function*(){const e=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==e.length){if(window.confirm("Sei sicuro di voler eliminare le copie selezionate?"))try{const n=s.transaction("Copie","readwrite").objectStore("Copie"),r=Array.from(e).map((e=>t(this,void 0,void 0,(function*(){var t,r;const i=e.closest("tr");if(i){const e=null===(r=null===(t=i.cells[1])||void 0===t?void 0:t.textContent)||void 0===r?void 0:r.trim();if(e)return new Promise(((t,r)=>{const i=n.get(Number(e));i.onsuccess=()=>{const c=i.result;if(c){console.log("RIsultato prova eliminazione:"+c),c.stato="E";const i=n.put(c);i.onsuccess=()=>{o.postMessage({store:"Copie"}),b(c),t()},i.onerror=()=>{r(new Error(`Errore nell'aggiornamento della copia ${e}.`))}}else r(new Error(`Copia con ID ${e} non trovata.`))},i.onerror=()=>{r(new Error(`Errore nel recupero della copia ${e}.`))}}));Promise.resolve()}else Promise.resolve()}))));yield Promise.all(r),window.alert("Copia/e eliminate."),yield z()}catch(e){e instanceof Error&&console.error(e.message)}}else window.alert("Seleziona almeno una copia da eliminare.")}))}));const y=document.getElementById("vendiCopie");null==y||y.addEventListener("click",(function(){return t(this,void 0,void 0,(function*(){const e=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==e.length){if(window.confirm("Sei sicuro di voler vendere le copie selezionate?"))try{const n=s.transaction("Copie","readwrite").objectStore("Copie"),r=Array.from(e).map((e=>t(this,void 0,void 0,(function*(){var t,r;const i=e.closest("tr");if(i){const e=null===(r=null===(t=i.cells[1])||void 0===t?void 0:t.textContent)||void 0===r?void 0:r.trim();if(e)return new Promise(((t,r)=>{const i=n.get(Number(e));i.onsuccess=()=>{const c=i.result;if(c){c.stato="V";const i=n.put(c);i.onsuccess=()=>{o.postMessage({store:"Copie"}),o.postMessage({store:"Venditori"}),b(c),t()},i.onerror=()=>{r(new Error(`Errore nell'aggiornamento della copia ${e}.`))}}else r(new Error(`Copia con ID ${e} non trovata.`))},i.onerror=()=>{r(new Error(`Errore nel recupero della copia ${e}.`))}}));Promise.resolve()}else Promise.resolve()}))));yield Promise.all(r),window.alert("Copia/e vendute con successo."),yield z()}catch(e){e instanceof Error&&console.error(e.message)}}else window.alert("Seleziona almeno una copia da vendere.")}))}));const C=document.getElementById("ottieniBarcode");function b(o){return t(this,void 0,void 0,(function*(){let r;if(o instanceof e)r=o;else{const n=o,i=yield D(Number(n.libroDellaCopiaISBN)),c=yield function(e){return t(this,void 0,void 0,(function*(){const o=s.transaction("Venditori","readonly").objectStore("Venditori");return yield new Promise(((n,t)=>{const r=o.get(e);r.onsuccess=()=>{r.result?n(r.result):t(new Error("Venditore non trovato con codice fiscale: "+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),t(r.error)}}))}))}(Number(n.venditoreID));r=new e(i,Number(n.codiceUnivoco),Number(n.prezzoCopertina),c,n.stato)}n.send("C,"+String(null==r?void 0:r.toString()))}))}function E(){null!=p&&(p.style.display="flex")}function S(){null!=p&&(p.style.display="none")}function z(){return t(this,void 0,void 0,(function*(){try{const e=yield function(){return t(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const n=s.transaction("Copie","readonly").objectStore("Copie").index("venditoreID").getAll(c);n.onsuccess=()=>{e(n.result)},n.onerror=()=>{o(n.error)}}))}))}();if(!c)throw new Error("ID venditore non valido");const o=s.transaction("Venditori","readonly").objectStore("Venditori");a=yield new Promise(((e,n)=>{const t=o.get(c);t.onsuccess=()=>{t.result?e(t.result):n(new Error("Venditore non trovato con ID: "+c))},t.onerror=e=>{console.error("Errore nella richiesta:",e),n(t.error)}}));const n=document.getElementById("corpoInfoVenditore");n.innerHTML="";const r=function(e){let o=0;for(let n=0;n<e.length;n++)"V"==e[n].stato&&(o+=e[n].prezzoScontato);return Number(o.toFixed(2))}(e),i=document.createElement("tr");i.innerHTML=`<td>${a.id}</td><td>${a.nome}</td><td>${a.cognome}</td><td>${a.email}</td><td>${a.nTelefono}</td><td>${a.classe}</td><td>${r}</td>`,n.appendChild(i);const l=document.getElementById("corpoTabellaCopie");l.innerHTML="";for(let o=0;o<e.length;o++){const n=e[o];if("E"!==n.stato){const e=yield new Promise(((e,o)=>{const t=s.transaction("Libri","readonly").objectStore("Libri").get(n.libroDellaCopiaISBN);t.onsuccess=()=>{t.result?e(t.result):o(new Error("Libro con ISBN non trovato"))},t.onerror=()=>{o(new Error("Database dei libri non reperibile"))}})),o=document.createElement("tr"),t=document.createElement("td"),r=document.createElement("input");r.setAttribute("type","checkbox"),r.setAttribute("class","caselleSelezione"),"V"===n.stato&&(r.disabled=!0,o.classList.add("venduta")),t.appendChild(r),o.appendChild(t);const i=document.createElement("td");i.textContent=String(n.codiceUnivoco),o.appendChild(i);const c=document.createElement("td");c.textContent=String(e.isbn),o.appendChild(c);const a=document.createElement("td");a.textContent=e.titolo,o.appendChild(a);const d=document.createElement("td");d.textContent=String(n.prezzoCopertina),o.appendChild(d);const u=document.createElement("td");u.textContent=String(n.prezzoScontato),o.appendChild(u),l.appendChild(o)}}}catch(e){e instanceof Error&&console.error(e.message)}}))}function I(e,o,n="0"){return e.toString().padStart(o,n)}function D(e){return t(this,void 0,void 0,(function*(){const o=s.transaction("Libri","readonly").objectStore("Libri");return yield new Promise(((n,t)=>{const r=o.get(e);r.onsuccess=()=>{r.result?n(r.result):t(new Error("Libro non trovato con ISBN"+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),t(r.error)}}))}))}function B(e,o){return r=document.createElement("canvas"),r.id="canvaBarcode",document.body.appendChild(r),JsBarcode(r,I(e,4),{format:"CODE128",width:2,text:I(o,4),height:100,displayValue:!0}),r.toDataURL("image/jpeg")}function L(e,o){const n=document.createElement("a");n.href=e,n.download=o,document.body.appendChild(n),n.click(),document.body.removeChild(n),r.remove()}null==C||C.addEventListener("click",(function(){return t(this,void 0,void 0,(function*(){const e=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==e.length)try{const o=s.transaction("Copie","readwrite").objectStore("Copie"),n=Array.from(e).map((e=>t(this,void 0,void 0,(function*(){var n,t;const r=e.closest("tr");if(r){const e=null===(t=null===(n=r.cells[1])||void 0===n?void 0:n.textContent)||void 0===t?void 0:t.trim();if(e)return new Promise(((n,t)=>{const r=o.get(Number(e));r.onsuccess=()=>{const e=r.result;L(B(e.codiceUnivoco,a.id),`${e.codiceUnivoco}_copiaID`),n()},r.onerror=()=>{t(new Error(`Errore nel recupero della copia ${e}.`))}}));Promise.resolve()}else Promise.resolve()}))));yield Promise.all(n),window.alert("Download avviati!")}catch(e){e instanceof Error&&console.error(e.message)}}))})),n.onopen=function(){console.log("aperto il server")},n.onclose=function(){console.log("connessione server chiusa")},n.onerror=function(e){console.log("errore nel webSocket",e)},o.onmessage=e=>t(void 0,void 0,void 0,(function*(){"Copie"===e.data.store&&(console.log("Aggiornamento ricevuto: ricarico copie..."),location.reload())})),document.addEventListener("DOMContentLoaded",(()=>t(void 0,void 0,void 0,(function*(){try{s=yield function(){let e=new Promise(((e,o)=>{const n=indexedDB.open("Database",1);n.onerror=()=>{o(n.onerror)},n.onsuccess=()=>{const o=n.result;e(o)}}));return e}(),console.log("Database aperto:",s.name),yield z(),null!=l&&function(){t(this,void 0,void 0,(function*(){try{null!=l&&(d=yield D(Number(l)),h.value=i.get("prezzoCopertina"),g.value=d.titolo,E())}catch(e){console.error("Venditore NON reperibile",e)}}))}()}catch(e){console.error(e)}}))))})();