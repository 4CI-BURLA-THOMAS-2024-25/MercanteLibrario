(()=>{"use strict";var e={772:(e,o,n)=>{n.d(o,{N:()=>t});class t{constructor(e,o,n,t,r){this.libroDellaCopiaISBN=e.isbn,this.codiceUnivoco=o,this.prezzoCopertina=n,this.prezzoScontato=parseFloat((.5*n).toFixed(2)),this.venditoreID=t.id,this.stato=r}toString(){return`${this.libroDellaCopiaISBN};${this.codiceUnivoco};${this.prezzoCopertina};${this.prezzoScontato};${this.venditoreID};${this.stato}`}}},783:(e,o,n)=>{n.d(o,{D:()=>t});const t=new BroadcastChannel("aggiornamentoDatabase")},903:(e,o,n)=>{n.d(o,{ws:()=>t});const t=new WebSocket("ws://192.168.1.100:8082");t.onopen=function(){console.log("aperto il server")},t.onclose=function(){console.log("connessione server chiusa")},t.onerror=function(e){console.log("errore nel webSocket",e)}}},o={};function n(t){var r=o[t];if(void 0!==r)return r.exports;var i=o[t]={exports:{}};return e[t](i,i.exports,n),i.exports}n.d=(e,o)=>{for(var t in o)n.o(o,t)&&!n.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:o[t]})},n.o=(e,o)=>Object.prototype.hasOwnProperty.call(e,o);var t=n(772),r=n(783),i=n(903),c=function(e,o,n,t){return new(n||(n=Promise))((function(r,i){function c(e){try{l(t.next(e))}catch(e){i(e)}}function s(e){try{l(t.throw(e))}catch(e){i(e)}}function l(e){var o;e.done?r(e.value):(o=e.value,o instanceof n?o:new n((function(e){e(o)}))).then(c,s)}l((t=t.apply(e,o||[])).next())}))};const s=new URLSearchParams(window.location.search),l=Number(s.get("venditoreID")),a=s.get("isbn");let d,u,p;const v=document.getElementById("aggiungiCopia");null==v||v.addEventListener("click",S);const m=document.getElementById("popupRegistraCopia"),f=document.getElementById("registraCopia");null==f||f.addEventListener("click",(function(){return c(this,void 0,void 0,(function*(){const e=yield function(){return c(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const n=d.transaction("Copie","readonly").objectStore("Copie").openCursor(null,"prev");n.onsuccess=()=>{const o=n.result;e(o?o.primaryKey:null)},n.onerror=()=>{o(n.error)}}))}))}();let o;if(o=null!==e?e+1:1,""!==w.value)if(null!=p){const e=new t.N(p,o,parseFloat(w.value),u,"D");p=null,yield function(e){return c(this,void 0,void 0,(function*(){const o=d.transaction("Copie","readwrite").objectStore("Copie").add(e);o.onsuccess=()=>{w.value="",y.value="",s.delete("isbn"),s.delete("prezzoCopertina"),r.D.postMessage({store:"Copie"}),E(e);const o=`${window.location.pathname}?${s.toString()}`;window.history.replaceState({},"",o),I(),z()},o.onerror=()=>{console.error("Copia giÃ  presente")}}))}(e)}else window.alert("Scegliere un libro dalla libreria da associarte alla copia che si vuole registrare");else window.alert("Inserire il prezzo di copertina per procedere con la registrazione")}))}));const g=document.getElementById("chiudiPopup");null==g||g.addEventListener("click",z);const h=document.getElementById("scegliLibro");null==h||h.addEventListener("click",(function(){const e=new URLSearchParams;e.set("venditoreID",String(u.id));const o=w.value;e.set("prezzoCopertina",o),window.location.href=`selezionaLibro.html?${e.toString()}`}));const w=document.getElementById("prezzoCopertina"),y=document.getElementById("titoloLibro"),b=document.getElementById("eliminaCopie");null==b||b.addEventListener("click",(function(){return c(this,void 0,void 0,(function*(){const e=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==e.length){if(window.confirm("Sei sicuro di voler eliminare le copie selezionate?"))try{const o=d.transaction("Copie","readwrite").objectStore("Copie"),n=Array.from(e).map((e=>c(this,void 0,void 0,(function*(){var n,t;const i=e.closest("tr");if(i){const e=null===(t=null===(n=i.cells[1])||void 0===n?void 0:n.textContent)||void 0===t?void 0:t.trim();if(e)return new Promise(((n,t)=>{const i=o.get(Number(e));i.onsuccess=()=>{const c=i.result;if(c){console.log("RIsultato prova eliminazione:"+c),c.stato="E";const i=o.put(c);i.onsuccess=()=>{r.D.postMessage({store:"Copie"}),E(c),n()},i.onerror=()=>{t(new Error(`Errore nell'aggiornamento della copia ${e}.`))}}else t(new Error(`Copia con ID ${e} non trovata.`))},i.onerror=()=>{t(new Error(`Errore nel recupero della copia ${e}.`))}}));Promise.resolve()}else Promise.resolve()}))));yield Promise.all(n),window.alert("Copia/e eliminate."),yield I()}catch(e){e instanceof Error&&console.error(e.message)}}else window.alert("Seleziona almeno una copia da eliminare.")}))}));const C=document.getElementById("vendiCopie");function E(e){return c(this,void 0,void 0,(function*(){let o;if(e instanceof t.N)o=e;else{const n=e,r=yield D(Number(n.libroDellaCopiaISBN)),i=yield function(e){return c(this,void 0,void 0,(function*(){const o=d.transaction("Venditori","readonly").objectStore("Venditori");return yield new Promise(((n,t)=>{const r=o.get(e);r.onsuccess=()=>{r.result?n(r.result):t(new Error("Venditore non trovato con codice fiscale: "+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),t(r.error)}}))}))}(Number(n.venditoreID));o=new t.N(r,Number(n.codiceUnivoco),Number(n.prezzoCopertina),i,n.stato)}i.ws.send("C,"+String(null==o?void 0:o.toString()))}))}function S(){null!=m&&(m.style.display="flex")}function z(){null!=m&&(m.style.display="none")}function I(){return c(this,void 0,void 0,(function*(){try{const e=yield function(){return c(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const n=d.transaction("Copie","readonly").objectStore("Copie").index("venditoreID").getAll(l);n.onsuccess=()=>{e(n.result)},n.onerror=()=>{o(n.error)}}))}))}();if(!l)throw new Error("ID venditore non valido");const o=d.transaction("Venditori","readonly").objectStore("Venditori");u=yield new Promise(((e,n)=>{const t=o.get(l);t.onsuccess=()=>{t.result?e(t.result):n(new Error("Venditore non trovato con ID: "+l))},t.onerror=e=>{console.error("Errore nella richiesta:",e),n(t.error)}}));const n=document.getElementById("corpoInfoVenditore");n.innerHTML="";const t=function(e){let o=0;for(let n=0;n<e.length;n++)"V"==e[n].stato&&(o+=e[n].prezzoScontato);return Number(o.toFixed(2))}(e),r=document.createElement("tr");r.innerHTML=`<td>${u.id}</td><td>${u.nome}</td><td>${u.cognome}</td><td>${u.email}</td><td>${u.nTelefono}</td><td>${u.classe}</td><td>${t}</td>`,n.appendChild(r);const i=document.getElementById("corpoTabellaCopie");i.innerHTML="";for(let o=0;o<e.length;o++){const n=e[o];if("E"!==n.stato){const e=yield new Promise(((e,o)=>{const t=d.transaction("Libri","readonly").objectStore("Libri").get(n.libroDellaCopiaISBN);t.onsuccess=()=>{t.result?e(t.result):o(new Error("Libro con ISBN non trovato"))},t.onerror=()=>{o(new Error("Database dei libri non reperibile"))}})),o=document.createElement("tr"),t=document.createElement("td"),r=document.createElement("input");r.setAttribute("type","checkbox"),r.setAttribute("class","caselleSelezione"),"V"===n.stato&&(r.disabled=!0,o.classList.add("venduta")),t.appendChild(r),o.appendChild(t);const c=document.createElement("td");c.textContent=String(n.codiceUnivoco),o.appendChild(c);const s=document.createElement("td");s.textContent=String(e.isbn),o.appendChild(s);const l=document.createElement("td");l.textContent=e.titolo,o.appendChild(l);const a=document.createElement("td");a.textContent=String(n.prezzoCopertina),o.appendChild(a);const u=document.createElement("td");u.textContent=String(n.prezzoScontato),o.appendChild(u),i.appendChild(o)}}}catch(e){e instanceof Error&&console.error(e.message)}}))}function D(e){return c(this,void 0,void 0,(function*(){const o=d.transaction("Libri","readonly").objectStore("Libri");return yield new Promise(((n,t)=>{const r=o.get(e);r.onsuccess=()=>{r.result?n(r.result):t(new Error("Libro non trovato con ISBN"+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),t(r.error)}}))}))}null==C||C.addEventListener("click",(function(){return c(this,void 0,void 0,(function*(){const e=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==e.length){if(window.confirm("Sei sicuro di voler vendere le copie selezionate?"))try{const o=d.transaction("Copie","readwrite").objectStore("Copie"),n=Array.from(e).map((e=>c(this,void 0,void 0,(function*(){var n,t;const i=e.closest("tr");if(i){const e=null===(t=null===(n=i.cells[1])||void 0===n?void 0:n.textContent)||void 0===t?void 0:t.trim();if(e)return new Promise(((n,t)=>{const i=o.get(Number(e));i.onsuccess=()=>{const c=i.result;if(c){c.stato="V";const i=o.put(c);i.onsuccess=()=>{r.D.postMessage({store:"Copie"}),r.D.postMessage({store:"Venditori"}),E(c),n()},i.onerror=()=>{t(new Error(`Errore nell'aggiornamento della copia ${e}.`))}}else t(new Error(`Copia con ID ${e} non trovata.`))},i.onerror=()=>{t(new Error(`Errore nel recupero della copia ${e}.`))}}));Promise.resolve()}else Promise.resolve()}))));yield Promise.all(n),window.alert("Copia/e vendute con successo."),yield I()}catch(e){e instanceof Error&&console.error(e.message)}}else window.alert("Seleziona almeno una copia da vendere.")}))})),i.ws.onopen=function(){console.log("aperto il server")},i.ws.onclose=function(){console.log("connessione server chiusa")},i.ws.onerror=function(e){console.log("errore nel webSocket",e)},r.D.onmessage=e=>c(void 0,void 0,void 0,(function*(){"Copie"===e.data.store&&(console.log("Aggiornamento ricevuto: ricarico copie..."),location.reload())})),document.addEventListener("DOMContentLoaded",(()=>c(void 0,void 0,void 0,(function*(){try{d=yield function(){let e=new Promise(((e,o)=>{const n=indexedDB.open("Database",1);n.onerror=()=>{o(n.onerror)},n.onsuccess=()=>{const o=n.result;e(o)}}));return e}(),console.log("Database aperto:",d.name),yield I(),null!=a&&function(){c(this,void 0,void 0,(function*(){try{null!=a&&(p=yield D(Number(a)),w.value=s.get("prezzoCopertina"),y.value=p.titolo,S())}catch(e){console.error("Venditore NON reperibile",e)}}))}()}catch(e){console.error(e)}}))))})();