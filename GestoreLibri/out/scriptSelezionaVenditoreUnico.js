(()=>{"use strict";class e{constructor(e,t,n,o,r,c){let i=Number(r);this.codFiscale=null!=e?e:"-",this.nome=null!=t?t:"-",this.cognome=null!=n?n:"-",this.email=null!=o?o:"-",this.nTelefono=i>0?i:0,this.classe=null!=c?c:"-"}}const t=new BroadcastChannel("aggiornamentoDatabase");var n=function(e,t,n,o){return new(n||(n=Promise))((function(r,c){function i(e){try{d(o.next(e))}catch(e){c(e)}}function l(e){try{d(o.throw(e))}catch(e){c(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,l)}d((o=o.apply(e,t||[])).next())}))};const o=new URLSearchParams(window.location.search),r=o.get("isbn"),c=o.get("percentualeSconto");let i;const l=document.getElementById("aggiungiVenditore");null==l||l.addEventListener("click",(function(){null!=d&&(d.style.display="flex")}));const d=document.getElementById("popupNuovoVenditore"),a=document.getElementById("registraVenditore");null==a||a.addEventListener("click",(function(){let n=new Array(6);for(let e=0;e<u.length;e++)n[e]=u[e].value;const o=new e(n[0],n[1],n[2],n[3],n[4],n[5]),r=i.transaction("Venditori","readwrite").objectStore("Venditori").add(o);r.onsuccess=()=>{h(),p(),t.postMessage({store:"Venditori",action:"add"})},r.onerror=()=>{console.error("Venditore giÃ  presente")}}));const s=document.getElementById("chiudiPopup");null==s||s.addEventListener("click",p);const u=document.querySelectorAll(".testoInputPopup"),m=document.getElementById("tornaAlleCopie");function p(){null!=d&&(d.style.display="none")}function h(){return n(this,void 0,void 0,(function*(){const e=i.transaction("Venditori","readonly").objectStore("Venditori");try{!function(e){n(this,void 0,void 0,(function*(){const t=document.getElementById("corpoTabellaVenditori");t.innerHTML="";const o=yield function(){return n(this,void 0,void 0,(function*(){let e=new Array;const t=yield new Promise(((e,t)=>{const n=i.transaction("Venditori","readonly").objectStore("Venditori").getAll();n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)}));for(const n of t){const t=(yield new Promise(((e,t)=>{const o=i.transaction("Copie","readonly").objectStore("Copie").index("venditoreCF").getAll(n.codFiscale);o.onsuccess=()=>e(o.result),o.onerror=()=>t(o.error)}))).reduce(((e,t)=>e+t.prezzoScontato),0);e.push(t)}return e}))}();for(let n=0;n<e.length;n++){const r=document.createElement("tr"),c=document.createElement("td"),i=document.createElement("input");i.setAttribute("type","checkbox"),i.setAttribute("class","caselleSelezione"),c.appendChild(i),r.appendChild(i);const l=document.createElement("td"),d=document.createElement("button");d.textContent="Rimuovi venditore",d.addEventListener("click",(()=>v(e[n].codFiscale))),l.appendChild(d),r.appendChild(l);const a=document.createElement("td");a.textContent=e[n].codFiscale,r.appendChild(a);const s=document.createElement("td");s.textContent=e[n].nome,r.appendChild(s);const u=document.createElement("td");u.textContent=e[n].cognome,r.appendChild(u);const m=document.createElement("td");m.textContent=e[n].email,r.appendChild(m);const p=document.createElement("td");p.textContent=String(e[n].nTelefono),r.appendChild(p);const h=document.createElement("td");h.textContent=e[n].classe,r.appendChild(h);const f=document.createElement("td");f.textContent=String(o[n]),r.appendChild(f),t.appendChild(r)}}))}(yield new Promise(((t,n)=>{const o=e.getAll();o.onsuccess=()=>t(o.result),o.onerror=()=>n(o.error)})))}catch(e){window.alert("Errore durante il caricamento dei venditori:"+e)}}))}function v(e){return n(this,void 0,void 0,(function*(){if(window.confirm("Sei sicuro di voler cancellare il venditore?"))try{const n=i.transaction("Venditori","readwrite").objectStore("Venditori").delete(e);yield new Promise(((e,o)=>{n.onsuccess=()=>{window.alert("Venditore eliminato con successo"),t.postMessage({store:"Venditori",action:"delete"}),e()},n.onerror=()=>{console.error("Errore nella cancellazione:",n.error),o(n.error)}})),h()}catch(e){window.alert("Errore nella cancellazione:"+e)}else window.alert("Eliminazione annullata")}))}null==m||m.addEventListener("click",(()=>function(){var e,t;const n=null===(e=document.querySelector("input[type='checkbox']:checked"))||void 0===e?void 0:e.closest("tr");if(n){const e=null===(t=n.querySelector("td:nth-child(3)"))||void 0===t?void 0:t.textContent,o=new URLSearchParams;o.set("isbn",r),o.set("percentualeSconto",c),o.set("codiceFiscale",e),window.location.href=`popupGestoreCopie.html?${o.toString()}`}else alert("Seleziona una riga prima di tornare indietro.")}())),document.addEventListener("DOMContentLoaded",(()=>n(void 0,void 0,void 0,(function*(){try{i=yield function(){let e=new Promise(((e,t)=>{const n=indexedDB.open("Database",1);n.onerror=()=>{t(n.onerror)},n.onsuccess=()=>{const t=n.result;e(t)}}));return e}(),console.log("Database aperto:",i.name),yield h();const e=document.querySelectorAll(".caselleSelezione");e.forEach((t=>{t.addEventListener("change",(()=>{t.checked&&e.forEach((e=>{e!==t&&(e.checked=!1)}))}))}))}catch(e){console.error("Errore apertura DB:",e)}}))))})();