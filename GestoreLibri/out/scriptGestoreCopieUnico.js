(()=>{"use strict";class e{constructor(e,o,n,t){this.libroDellaCopiaISBN=e.isbn,this.codiceUnivoco=o,this.prezzoScontato=e.prezzoListino*n,this.venditore=t}}const o=new BroadcastChannel("aggiornamentoDatabase");var n=function(e,o,n,t){return new(n||(n=Promise))((function(r,i){function c(e){try{l(t.next(e))}catch(e){i(e)}}function s(e){try{l(t.throw(e))}catch(e){i(e)}}function l(e){var o;e.done?r(e.value):(o=e.value,o instanceof n?o:new n((function(e){e(o)}))).then(c,s)}l((t=t.apply(e,o||[])).next())}))};const t=new URLSearchParams(window.location.search),r=t.get("isbn"),i=t.get("codiceFiscale");let c,s,l;const d=document.getElementById("aggiungiCopia");null==d||d.addEventListener("click",y);const a=document.getElementById("popupRegistraCopia"),u=document.getElementById("registraCopia");null==u||u.addEventListener("click",(function(){return n(this,void 0,void 0,(function*(){const t=yield function(){return n(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const n=c.transaction("Copie","readonly").objectStore("Copie").openCursor(null,"prev");n.onsuccess=()=>{const o=n.result;e(o?o.primaryKey:null)},n.onerror=()=>{o(n.error)}}))}))}();let r;if(r=null!==t?t+1:1,"default"!==v.value){const n=new e(s,r,parseFloat(v.value),l),t=c.transaction("Copie","readwrite").objectStore("Copie").add(n);t.onsuccess=()=>{console.log(s),g(),h(),o.postMessage({store:"Copie",action:"add"})},t.onerror=()=>{console.error("Copia giÃ  presente")}}}))}));const p=document.getElementById("chiudiPopup");null==p||p.addEventListener("click",h);const m=document.getElementById("scegliVenditore");null==m||m.addEventListener("click",(function(){const e=new URLSearchParams;e.set("isbn",r);const o=v.value;e.set("percentualeSconto",o),window.location.href=`selezionaVenditore.html?${e.toString()}`}));const v=document.getElementById("selezionaSconto"),f=document.getElementById("IDVenditore");function g(){return n(this,void 0,void 0,(function*(){const e=yield function(){return n(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const n=c.transaction("Copie","readonly").objectStore("Copie").index("libroDellaCopiaISBN");console.log(r);const t=n.getAll(Number(r));t.onsuccess=()=>{e(t.result)},t.onerror=()=>{o(t.error)}}))}))}();if(!r)throw new Error("ISBN non valido");console.log("ISBN cercato:",r);const o=c.transaction("Libri","readonly").objectStore("Libri");if(s=yield new Promise(((e,n)=>{const t=o.get(Number(r));t.onsuccess=()=>{t.result?e(t.result):n(new Error("Libro non trovato con ISBN: "+r))},t.onerror=e=>{console.error("Errore nella richiesta:",e),n(t.error)}})),s){const o=document.getElementById("corpoInfoLibro");o.innerHTML="";const n=document.createElement("tr");n.innerHTML=`<td>${s.materia}</td><td>${s.isbn}</td><td>${s.autore}</td><td>${s.titolo}</td><td>${s.volume}</td><td>${s.editore}</td><td>${s.prezzoListino}</td><td>${s.classe}</td>`,o.appendChild(n);const t=document.getElementById("corpoTabellaCopie");t.innerHTML="";for(let o=0;o<e.length;o++){let n=e[o];const r=document.createElement("tr");r.innerHTML=`<td>${n.codiceUnivoco}</td><td>${n.venditore}</td><td>${n.prezzoScontato}</td>`,t.appendChild(r)}}else console.error("Libro non trovato con ISBN:",r)}))}function y(){null!=a&&(a.style.display="flex")}function h(){null!=a&&(a.style.display="none")}document.addEventListener("DOMContentLoaded",(()=>n(void 0,void 0,void 0,(function*(){try{c=yield function(){let e=new Promise(((e,o)=>{const n=indexedDB.open("Database",1);n.onerror=()=>{o(n.onerror)},n.onsuccess=()=>{const o=n.result;e(o)}}));return e}(),console.log("Database aperto:",c.name),yield g(),null!=i&&function(){n(this,void 0,void 0,(function*(){try{null!=i&&(l=yield function(e){return n(this,void 0,void 0,(function*(){const o=c.transaction("Venditori","readonly").objectStore("Venditori");return yield new Promise(((n,t)=>{const r=o.get(e);r.onsuccess=()=>{r.result?n(r.result):t(new Error("Venditore non trovato con codice fiscale: "+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),t(r.error)}}))}))}(i),v.value=t.get("percentualeSconto"),f.value=l.nome+" "+l.cognome,y())}catch(e){console.error("Venditore NON reperibile",e)}}))}()}catch(e){console.error(e)}}))))})();