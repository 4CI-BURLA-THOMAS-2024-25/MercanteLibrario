(()=>{"use strict";class e{constructor(e,o,n,t){this.libroDellaCopiaISBN=e.isbn,this.codiceUnivoco=o,this.prezzoScontato=parseFloat((e.prezzoListino*n).toFixed(2)),this.venditoreCF=t.codFiscale}toString(){return`${this.libroDellaCopiaISBN,this.codiceUnivoco,this.prezzoScontato,this.venditoreCF}`}}var o=function(e,o,n,t){return new(n||(n=Promise))((function(r,i){function c(e){try{l(t.next(e))}catch(e){i(e)}}function s(e){try{l(t.throw(e))}catch(e){i(e)}}function l(e){var o;e.done?r(e.value):(o=e.value,o instanceof n?o:new n((function(e){e(o)}))).then(c,s)}l((t=t.apply(e,o||[])).next())}))};const n=new URLSearchParams(window.location.search),t=n.get("isbn"),r=n.get("codiceFiscale");let i,c,s;const l=document.getElementById("aggiungiCopia");null==l||l.addEventListener("click",g);const d=document.getElementById("popupRegistraCopia"),a=document.getElementById("registraCopia");null==a||a.addEventListener("click",(function(){return o(this,void 0,void 0,(function*(){const n=yield function(){return o(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const n=i.transaction("Copie","readonly").objectStore("Copie").openCursor(null,"prev");n.onsuccess=()=>{const o=n.result;e(o?o.primaryKey:null)},n.onerror=()=>{o(n.error)}}))}))}();let t;if(t=null!==n?n+1:1,"default"!==v.value){const o=new e(c,t,parseFloat(v.value),s),n=i.transaction("Copie","readwrite").objectStore("Copie").add(o);n.onsuccess=()=>{f(),h()},n.onerror=()=>{console.error("Copia giÃ  presente")}}}))}));const u=document.getElementById("chiudiPopup");null==u||u.addEventListener("click",h);const p=document.getElementById("scegliVenditore");null==p||p.addEventListener("click",(function(){const e=new URLSearchParams;e.set("isbn",t);const o=v.value;e.set("percentualeSconto",o),window.location.href=`selezionaVenditore.html?${e.toString()}`}));const v=document.getElementById("selezionaSconto"),m=document.getElementById("IDVenditore");function f(){return o(this,void 0,void 0,(function*(){const e=yield function(){return o(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const n=i.transaction("Copie","readonly").objectStore("Copie").index("libroDellaCopiaISBN");console.log(t);const r=n.getAll(Number(t));r.onsuccess=()=>{e(r.result)},r.onerror=()=>{o(r.error)}}))}))}();if(!t)throw new Error("ISBN non valido");const n=i.transaction("Libri","readonly").objectStore("Libri");if(c=yield new Promise(((e,o)=>{const r=n.get(Number(t));r.onsuccess=()=>{r.result?e(r.result):o(new Error("Libro non trovato con ISBN: "+t))},r.onerror=e=>{console.error("Errore nella richiesta:",e),o(r.error)}})),c){const o=document.getElementById("corpoInfoLibro");o.innerHTML="";const n=document.createElement("tr");n.innerHTML=`<td>${c.materia}</td><td>${c.isbn}</td><td>${c.autore}</td><td>${c.titolo}</td><td>${c.volume}</td><td>${c.editore}</td><td>${c.prezzoListino}</td><td>${c.classe}</td>`,o.appendChild(n);const t=document.getElementById("corpoTabellaCopie");t.innerHTML="";for(let o=0;o<e.length;o++){let n=e[o];const r=yield new Promise(((e,o)=>{const t=i.transaction("Venditori","readonly").objectStore("Venditori").get(n.venditoreCF);t.onsuccess=()=>{t.result?e(t.result):e(null)},t.onerror=()=>{e(null)}})),c=document.createElement("tr");c.innerHTML=`<td>${n.codiceUnivoco}</td>\n                            <td>${(null==r?void 0:r.nome)+"  "+(null==r?void 0:r.cognome)}</td>\n                            <td>${n.prezzoScontato}</td>`,t.appendChild(c)}}else console.error("Libro non trovato con ISBN:",t)}))}function g(){null!=d&&(d.style.display="flex")}function h(){null!=d&&(d.style.display="none")}document.addEventListener("DOMContentLoaded",(()=>o(void 0,void 0,void 0,(function*(){try{i=yield function(){let e=new Promise(((e,o)=>{const n=indexedDB.open("Database",1);n.onerror=()=>{o(n.onerror)},n.onsuccess=()=>{const o=n.result;e(o)}}));return e}(),console.log("Database aperto:",i.name);const t=new e(c,452,.7,s);console.log(t.toString()),yield f(),null!=r&&function(){o(this,void 0,void 0,(function*(){try{null!=r&&(s=yield function(e){return o(this,void 0,void 0,(function*(){const o=i.transaction("Venditori","readonly").objectStore("Venditori");return yield new Promise(((n,t)=>{const r=o.get(e);r.onsuccess=()=>{r.result?n(r.result):t(new Error("Venditore non trovato con codice fiscale: "+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),t(r.error)}}))}))}(r),v.value=n.get("percentualeSconto"),m.value=s.nome+" "+s.cognome,g())}catch(e){console.error("Venditore NON reperibile",e)}}))}();const l=new WebSocket("ws://localHost:8081");l.onopen=function(){console.log("aperto il server")},l.onclose=function(){console.log("connessione server chiusa")},l.onerror=function(e){console.log("errore nel webSocket",e)},l.onmessage=function(e){console.log(e.data),e.data.split(",")[0]}}catch(e){console.error(e)}}))))})();