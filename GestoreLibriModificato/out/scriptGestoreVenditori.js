(()=>{"use strict";class e{constructor(e,t,n,o,i,r){let c=Number(i);this.id=e>=0?e:0,this.nome=null!=t?t:"-",this.cognome=null!=n?n:"-",this.email=null!=o?o:"-",this.nTelefono=c>0?c:0,this.classe=null!=r?r:"-"}toString(){return[this.id,this.nome,this.cognome,this.email,this.nTelefono,this.classe].join(" ")}}const t=new BroadcastChannel("aggiornamentoDatabase");var n=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function l(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,l)}a((o=o.apply(e,t||[])).next())}))};let o,i;const r=document.getElementById("aggiungiVenditore");null==r||r.addEventListener("click",(function(){null!=c&&(c.style.display="flex")}));const c=document.getElementById("popupNuovoVenditore"),l=document.getElementById("registraVenditore");null==l||l.addEventListener("click",(function(){return n(this,void 0,void 0,(function*(){let i=new Array(5);for(let e=0;e<d.length;e++)i[e]=d[e].value;const r=yield function(){return n(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{const n=o.transaction("Venditori","readonly").objectStore("Venditori").openCursor(null,"prev");n.onsuccess=()=>{const t=n.result;e(t?t.primaryKey:null)},n.onerror=()=>{t(n.error)}}))}))}();let c;c=null!==r?r+1:1;const l=new e(c,i[0],i[1],i[2],Number(i[3]),i[4]),a=o.transaction("Venditori","readwrite").objectStore("Venditori").add(l);a.onsuccess=()=>{m();for(let e=0;e<d.length;e++)d[e].value="";u(),t.postMessage({store:"Venditori",action:"add"})},a.onerror=()=>{console.log("Venditore giÃ  presente")}}))}));const a=document.getElementById("chiudiPopup");null==a||a.addEventListener("click",u);const d=document.querySelectorAll(".testoInputPopup"),s=document.getElementById("casellaRicerca");function u(){null!=c&&(c.style.display="none")}function m(){return n(this,void 0,void 0,(function*(){let t;try{const n=o.transaction("Venditori","readonly").objectStore("Venditori");return t=(yield new Promise(((e,t)=>{const o=n.getAll();o.onsuccess=()=>e(o.result),o.onerror=()=>t(o.error)}))).map((t=>new e(t.id,t.nome,t.cognome,t.email,t.nTelefono,t.classe))),t}catch(e){return window.alert("Errore durante il caricamento dei venditori:"+e),null}}))}function p(e){return n(this,void 0,void 0,(function*(){const t=document.getElementById("corpoTabellaVenditori");if(t.innerHTML="",null!=e){const i=yield function(){return n(this,void 0,void 0,(function*(){let e=new Array;const t=yield new Promise(((e,t)=>{const n=o.transaction("Venditori","readonly").objectStore("Venditori").getAll();n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)}));for(const n of t){const t=(yield new Promise(((e,t)=>{const i=o.transaction("Copie","readonly").objectStore("Copie").index("venditoreID").getAll(n.id);i.onsuccess=()=>e(i.result),i.onerror=()=>t(i.error)}))).reduce(((e,t)=>e+t.prezzoScontato),0);e.push(t)}return e}))}();for(let n=0;n<e.length;n++){const o=document.createElement("tr"),r=document.createElement("td");r.textContent=String(e[n].id),o.appendChild(r);const c=document.createElement("td");c.textContent=e[n].nome,o.appendChild(c);const l=document.createElement("td");l.textContent=e[n].cognome,o.appendChild(l);const a=document.createElement("td");a.textContent=e[n].email,o.appendChild(a);const d=document.createElement("td");d.textContent=String(e[n].nTelefono),o.appendChild(d);const s=document.createElement("td");s.textContent=e[n].classe,o.appendChild(s);const u=document.createElement("td");u.textContent=String(i[n]),o.appendChild(u);const m=document.createElement("td"),p=document.createElement("button");p.textContent="Visualizza copie consegnate",p.addEventListener("click",(()=>h(e[n].id))),m.appendChild(p),o.appendChild(m),t.appendChild(o)}}else console.log("Nessun venditore da mostrare")}))}function h(e){const t=screen.height,n=screen.width;window.open(`html/gestoreCopieVenditore.html?venditoreID=${e}`,"_blank",`menubar=no", height=${t}, width=${n}, top=0, left=0`)}null==s||s.addEventListener("input",(function(){return n(this,void 0,void 0,(function*(){if(null!=i){let e,t=[];if(s&&""!==s.value.trim()){e=s.value.toLowerCase();for(let n=0;n<i.length;n++)i[n].toString().toLowerCase().includes(e)&&t.push(i[n]);yield p(t)}else yield p(i)}}))})),document.addEventListener("DOMContentLoaded",(()=>n(void 0,void 0,void 0,(function*(){try{o=yield function(){let e=new Promise(((e,t)=>{const n=indexedDB.open("Database",1);n.onerror=()=>{t(n.onerror)},n.onsuccess=()=>{const t=n.result;e(t)},n.onupgradeneeded=()=>{const e=n.result;if(!e.objectStoreNames.contains("Libri")){const t=e.createObjectStore("Libri",{keyPath:"isbn"});t.createIndex("materia","materia",{unique:!1}),t.createIndex("autore","autore",{unique:!1}),t.createIndex("titolo","titolo",{unique:!1}),t.createIndex("volume","volume",{unique:!1}),t.createIndex("editore","editore",{unique:!1}),t.createIndex("prezzoListino","prezzoListino",{unique:!1}),t.createIndex("classe","classe",{unique:!1})}if(!e.objectStoreNames.contains("Copie")){const t=e.createObjectStore("Copie",{keyPath:"codiceUnivoco"});t.createIndex("libroDellaCopiaISBN","libroDellaCopiaISBN",{unique:!1}),t.createIndex("prezzoScontato","prezzoScontato",{unique:!1}),t.createIndex("venditoreID","venditoreID",{unique:!1})}if(!e.objectStoreNames.contains("Venditori")){const t=e.createObjectStore("Venditori",{keyPath:"id"});t.createIndex("nome","nome",{unique:!1}),t.createIndex("cognome","cognome",{unique:!1}),t.createIndex("email","email",{unique:!1}),t.createIndex("nTelefono","nTelefono",{unique:!0}),t.createIndex("classe","classe",{unique:!1})}if(!e.objectStoreNames.contains("CopieEliminate")){const t=e.createObjectStore("CopieEliminate",{keyPath:"codiceUnivoco"});t.createIndex("libroDellaCopiaISBN","libroDellaCopiaISBN",{unique:!1}),t.createIndex("prezzoScontato","prezzoScontato",{unique:!1}),t.createIndex("venditoreID","venditoreID",{unique:!1})}}}));return e}(),console.log("Database aperto:",o.name),i=yield m(),yield p(i)}catch(e){console.error("Errore apertura DB:",e)}}))))})();