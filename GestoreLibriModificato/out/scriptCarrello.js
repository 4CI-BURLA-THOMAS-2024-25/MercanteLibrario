(()=>{"use strict";class e{constructor(e,o,t,n,r,i){this.libroDellaCopiaISBN=e.isbn,this.codiceUnivoco=o,this.prezzoCopertina=t,this.prezzoScontato=parseFloat((.5*t).toFixed(2)),this.venditoreID=n.id,this.stato=r,this.ultimaModifica=i}toString(){return`${this.libroDellaCopiaISBN};${this.codiceUnivoco};${this.prezzoCopertina};${this.prezzoScontato};${this.venditoreID};${this.stato};${this.ultimaModifica}`}}const o=new BroadcastChannel("aggiornamentoDatabase"),t=new WebSocket("ws://localHost:8081");t.onopen=function(){console.log("aperto il server")},t.onclose=function(){console.log("connessione server chiusa")},t.onerror=function(e){console.log("errore nel webSocket",e)};var n=function(e,o,t,n){return new(t||(t=Promise))((function(r,i){function c(e){try{l(n.next(e))}catch(e){i(e)}}function s(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var o;e.done?r(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(c,s)}l((n=n.apply(e,o||[])).next())}))};let r;const i=document.getElementById("rimuoviDalCarrello");null==i||i.addEventListener("click",(function(){return n(this,void 0,void 0,(function*(){const e=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==e.length){if(window.confirm("Vuoi rimuovere dal carrello le copie selezionate?"))try{const t=r.transaction("Copie","readwrite").objectStore("Copie"),i=Array.from(e).map((e=>n(this,void 0,void 0,(function*(){var n,r;const i=e.closest("tr");if(i){const e=null===(r=null===(n=i.cells[0])||void 0===n?void 0:n.textContent)||void 0===r?void 0:r.trim();if(e)return new Promise(((n,r)=>{const i=t.get(Number(e));i.onsuccess=()=>{const c=i.result;if(c){c.stato="D",c.ultimaModifica=(new Date).toLocaleString();const e=t.put(c);e.onsuccess=()=>{o.postMessage({store:"Copie"}),l(c),n()},e.onerror=()=>{r(new Error("Errore nell'aggiornamento dello stato della copia."))}}else r(new Error(`Copia con ID ${e} non trovata nello store 'Copie'.`))},i.onerror=()=>{r(new Error("Errore nel recupero della copia."))}}))}}))));yield Promise.all(i),window.alert("Copia/e rimossa dal carrello correttamente."),location.reload()}catch(e){e instanceof Error&&console.log(e.message)}}else window.alert("Seleziona almeno una copia da rimuovere dal cestino.")}))}));const c=document.getElementById("importoTotale"),s=document.getElementById("vendiCopie");function l(o){return n(this,void 0,void 0,(function*(){let i;if(o instanceof e)i=o;else{const t=o,c=yield function(e){return n(this,void 0,void 0,(function*(){const o=r.transaction("Libri","readonly").objectStore("Libri");return yield new Promise(((t,n)=>{const r=o.get(e);r.onsuccess=()=>{r.result?t(r.result):n(new Error("Libro non trovato con ISBN"+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),n(r.error)}}))}))}(Number(t.libroDellaCopiaISBN)),s=yield function(e){return n(this,void 0,void 0,(function*(){const o=r.transaction("Venditori","readonly").objectStore("Venditori");return yield new Promise(((t,n)=>{const r=o.get(e);r.onsuccess=()=>{r.result?t(r.result):n(new Error("Venditore non trovato con codice fiscale: "+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),n(r.error)}}))}))}(Number(t.venditoreID));i=new e(c,Number(t.codiceUnivoco),Number(t.prezzoCopertina),s,t.stato,t.ultimaModifica)}t.send("C-"+String(null==i?void 0:i.toString()))}))}function a(){return n(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const t=r.transaction("Copie","readonly").objectStore("Copie").getAll();t.onsuccess=()=>{const o=t.result.filter((e=>"CAR"===e.stato));e(o)},t.onerror=()=>{o(t.error)}}))}))}null==s||s.addEventListener("click",(function(){return n(this,void 0,void 0,(function*(){try{const e=yield a(),t=r.transaction("Copie","readwrite").objectStore("Copie"),i=Array.from(e).map((e=>n(this,void 0,void 0,(function*(){return new Promise(((n,r)=>{e.stato="V",e.ultimaModifica=(new Date).toLocaleString();const i=t.put(e);i.onsuccess=()=>{o.postMessage({store:"Copie"}),o.postMessage({store:"Venditori"}),l(e),n()},i.onerror=()=>{r(new Error("Impossibile vendere la copia"))}}))}))));yield Promise.all(i),location.reload()}catch(e){e instanceof Error&&console.error(e.message)}}))})),t.onopen=function(){console.log("aperto il server")},t.onclose=function(){console.log("connessione server chiusa")},t.onerror=function(e){console.log("errore nel webSocket",e)},o.onmessage=e=>n(void 0,void 0,void 0,(function*(){"Copie"===e.data.store&&(console.log("Aggiornamento ricevuto: ricarico carrello..."),location.reload())})),document.addEventListener("DOMContentLoaded",(()=>n(void 0,void 0,void 0,(function*(){try{r=yield function(){let e=new Promise(((e,o)=>{const t=indexedDB.open("Database",1);t.onerror=()=>{o(t.onerror)},t.onsuccess=()=>{const o=t.result;e(o)}}));return e}(),console.log("Database aperto:",r.name),yield function(){return n(this,void 0,void 0,(function*(){try{const e=yield a();!function(e){let o=0;e.forEach((e=>{o+=e.prezzoScontato})),c.value=String(o)}(e);const o=document.getElementById("corpoTabellaCopie");o.innerHTML="";for(let t=0;t<e.length;t++){let n=e[t];const i=yield new Promise(((e,o)=>{const t=r.transaction("Libri","readonly").objectStore("Libri").get(n.libroDellaCopiaISBN);t.onsuccess=()=>{t.result?e(t.result):o(new Error("Libro con ISBN non trovato"))},t.onerror=()=>{o(new Error("Database dei libri non reperibile"))}})),c=document.createElement("tr"),s=document.createElement("td"),l=document.createElement("input");l.setAttribute("type","checkbox"),l.setAttribute("class","caselleSelezione"),s.appendChild(l),c.appendChild(l);const a=document.createElement("td");a.textContent=String(n.codiceUnivoco),c.appendChild(a);const d=document.createElement("td");d.textContent=String(i.isbn),c.appendChild(d);const u=document.createElement("td");u.textContent=i.titolo,c.appendChild(u);const p=document.createElement("td");p.textContent=String(n.prezzoCopertina),c.appendChild(p);const m=document.createElement("td");m.textContent=String(n.prezzoScontato),c.appendChild(m),o.appendChild(c)}}catch(e){e instanceof Error&&console.error(e.message)}}))}()}catch(e){console.error(e)}}))))})();