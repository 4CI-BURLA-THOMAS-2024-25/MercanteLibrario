(()=>{"use strict";var e={772:(e,o,t)=>{t.d(o,{N:()=>n});class n{constructor(e,o,t,n,r){this.libroDellaCopiaISBN=e.isbn,this.codiceUnivoco=o,this.prezzoCopertina=t,this.prezzoScontato=parseFloat((.5*t).toFixed(2)),this.venditoreID=n.id,this.stato=r}toString(){return`${this.libroDellaCopiaISBN};${this.codiceUnivoco};${this.prezzoCopertina};${this.prezzoScontato};${this.venditoreID};${this.stato}`}}},783:(e,o,t)=>{t.d(o,{D:()=>n});const n=new BroadcastChannel("aggiornamentoDatabase")},903:(e,o,t)=>{t.d(o,{ws:()=>n});const n=new WebSocket("ws://localHost:8081");n.onopen=function(){console.log("aperto il server")},n.onclose=function(){console.log("connessione server chiusa")},n.onerror=function(e){console.log("errore nel webSocket",e)}}},o={};function t(n){var r=o[n];if(void 0!==r)return r.exports;var i=o[n]={exports:{}};return e[n](i,i.exports,t),i.exports}t.d=(e,o)=>{for(var n in o)t.o(o,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:o[n]})},t.o=(e,o)=>Object.prototype.hasOwnProperty.call(e,o);var n=t(772),r=t(783),i=t(903),c=function(e,o,t,n){return new(t||(t=Promise))((function(r,i){function c(e){try{l(n.next(e))}catch(e){i(e)}}function s(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var o;e.done?r(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(c,s)}l((n=n.apply(e,o||[])).next())}))};const s=new URLSearchParams(window.location.search),l=Number(s.get("venditoreID")),a=s.get("isbn");let d,u,p;const v=document.getElementById("aggiungiCopia");null==v||v.addEventListener("click",S);const m=document.getElementById("popupRegistraCopia"),f=document.getElementById("registraCopia");null==f||f.addEventListener("click",(function(){return c(this,void 0,void 0,(function*(){const e=yield function(){return c(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const t=d.transaction("Copie","readonly").objectStore("Copie").openCursor(null,"prev");t.onsuccess=()=>{const o=t.result;e(o?o.primaryKey:null)},t.onerror=()=>{o(t.error)}}))}))}();let o;if(o=null!==e?e+1:1,""!==w.value)if(null!=p){const e=new n.N(p,o,parseFloat(w.value),u,"D");p=null,yield function(e){return c(this,void 0,void 0,(function*(){const o=d.transaction("Copie","readwrite").objectStore("Copie").add(e);o.onsuccess=()=>{w.value="",y.value="",s.delete("isbn"),s.delete("prezzoCopertina"),r.D.postMessage({store:"Copie"}),E(e);const o=`${window.location.pathname}?${s.toString()}`;window.history.replaceState({},"",o),I(),z()},o.onerror=()=>{console.error("Copia giÃ  presente")}}))}(e)}else window.alert("Scegliere un libro dalla libreria da associarte alla copia che si vuole registrare");else window.alert("Inserire il prezzo di copertina per procedere con la registrazione")}))}));const g=document.getElementById("chiudiPopup");null==g||g.addEventListener("click",z);const h=document.getElementById("scegliLibro");null==h||h.addEventListener("click",(function(){const e=new URLSearchParams;e.set("venditoreID",String(u.id));const o=w.value;e.set("prezzoCopertina",o),window.location.href=`selezionaLibro.html?${e.toString()}`}));const w=document.getElementById("prezzoCopertina"),y=document.getElementById("titoloLibro"),b=document.getElementById("eliminaCopie");null==b||b.addEventListener("click",(function(){return c(this,void 0,void 0,(function*(){const e=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==e.length){if(window.confirm("Sei sicuro di voler eliminare le copie selezionate?"))try{const o=d.transaction("Copie","readwrite").objectStore("Copie"),t=Array.from(e).map((e=>c(this,void 0,void 0,(function*(){var t,n;const i=e.closest("tr");if(i){const e=null===(n=null===(t=i.cells[1])||void 0===t?void 0:t.textContent)||void 0===n?void 0:n.trim();if(e)return new Promise(((t,n)=>{const i=o.get(Number(e));i.onsuccess=()=>{const c=i.result;if(c){console.log("RIsultato prova eliminazione:"+c),c.stato="E";const i=o.put(c);i.onsuccess=()=>{r.D.postMessage({store:"Copie"}),E(c),t()},i.onerror=()=>{n(new Error(`Errore nell'aggiornamento della copia ${e}.`))}}else n(new Error(`Copia con ID ${e} non trovata.`))},i.onerror=()=>{n(new Error(`Errore nel recupero della copia ${e}.`))}}));Promise.resolve()}else Promise.resolve()}))));yield Promise.all(t),window.alert("Copia/e eliminate."),yield I()}catch(e){e instanceof Error&&console.error(e.message)}}else window.alert("Seleziona almeno una copia da eliminare.")}))}));const C=document.getElementById("vendiCopie");function E(e){return c(this,void 0,void 0,(function*(){let o;if(e instanceof n.N)o=e;else{const t=e,r=yield D(Number(t.libroDellaCopiaISBN)),i=yield function(e){return c(this,void 0,void 0,(function*(){const o=d.transaction("Venditori","readonly").objectStore("Venditori");return yield new Promise(((t,n)=>{const r=o.get(e);r.onsuccess=()=>{r.result?t(r.result):n(new Error("Venditore non trovato con codice fiscale: "+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),n(r.error)}}))}))}(Number(t.venditoreID));o=new n.N(r,Number(t.codiceUnivoco),Number(t.prezzoCopertina),i,t.stato)}i.ws.send("C,"+String(null==o?void 0:o.toString()))}))}function S(){null!=m&&(m.style.display="flex")}function z(){null!=m&&(m.style.display="none")}function I(){return c(this,void 0,void 0,(function*(){try{const e=yield function(){return c(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const t=d.transaction("Copie","readonly").objectStore("Copie").index("venditoreID").getAll(l);t.onsuccess=()=>{e(t.result)},t.onerror=()=>{o(t.error)}}))}))}();if(!l)throw new Error("ID venditore non valido");const o=d.transaction("Venditori","readonly").objectStore("Venditori");u=yield new Promise(((e,t)=>{const n=o.get(l);n.onsuccess=()=>{n.result?e(n.result):t(new Error("Venditore non trovato con ID: "+l))},n.onerror=e=>{console.error("Errore nella richiesta:",e),t(n.error)}}));const t=document.getElementById("corpoInfoVenditore");t.innerHTML="";const n=function(e){let o=0;for(let t=0;t<e.length;t++)"V"==e[t].stato&&(o+=e[t].prezzoScontato);return Number(o.toFixed(2))}(e),r=document.createElement("tr");r.innerHTML=`<td>${u.id}</td><td>${u.nome}</td><td>${u.cognome}</td><td>${u.email}</td><td>${u.nTelefono}</td><td>${u.classe}</td><td>${n}</td>`,t.appendChild(r);const i=document.getElementById("corpoTabellaCopie");i.innerHTML="";for(let o=0;o<e.length;o++){const t=e[o];if("E"!==t.stato){const e=yield new Promise(((e,o)=>{const n=d.transaction("Libri","readonly").objectStore("Libri").get(t.libroDellaCopiaISBN);n.onsuccess=()=>{n.result?e(n.result):o(new Error("Libro con ISBN non trovato"))},n.onerror=()=>{o(new Error("Database dei libri non reperibile"))}})),o=document.createElement("tr"),n=document.createElement("td"),r=document.createElement("input");r.setAttribute("type","checkbox"),r.setAttribute("class","caselleSelezione"),"V"===t.stato&&(r.disabled=!0,o.classList.add("venduta")),n.appendChild(r),o.appendChild(n);const c=document.createElement("td");c.textContent=String(t.codiceUnivoco),o.appendChild(c);const s=document.createElement("td");s.textContent=String(e.isbn),o.appendChild(s);const l=document.createElement("td");l.textContent=e.titolo,o.appendChild(l);const a=document.createElement("td");a.textContent=String(t.prezzoCopertina),o.appendChild(a);const u=document.createElement("td");u.textContent=String(t.prezzoScontato),o.appendChild(u),i.appendChild(o)}}}catch(e){e instanceof Error&&console.error(e.message)}}))}function D(e){return c(this,void 0,void 0,(function*(){const o=d.transaction("Libri","readonly").objectStore("Libri");return yield new Promise(((t,n)=>{const r=o.get(e);r.onsuccess=()=>{r.result?t(r.result):n(new Error("Libro non trovato con ISBN"+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),n(r.error)}}))}))}null==C||C.addEventListener("click",(function(){return c(this,void 0,void 0,(function*(){const e=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==e.length){if(window.confirm("Sei sicuro di voler vendere le copie selezionate?"))try{const o=d.transaction("Copie","readwrite").objectStore("Copie"),t=Array.from(e).map((e=>c(this,void 0,void 0,(function*(){var t,n;const i=e.closest("tr");if(i){const e=null===(n=null===(t=i.cells[1])||void 0===t?void 0:t.textContent)||void 0===n?void 0:n.trim();if(e)return new Promise(((t,n)=>{const i=o.get(Number(e));i.onsuccess=()=>{const c=i.result;if(c){c.stato="V";const i=o.put(c);i.onsuccess=()=>{r.D.postMessage({store:"Copie"}),r.D.postMessage({store:"Venditori"}),E(c),t()},i.onerror=()=>{n(new Error(`Errore nell'aggiornamento della copia ${e}.`))}}else n(new Error(`Copia con ID ${e} non trovata.`))},i.onerror=()=>{n(new Error(`Errore nel recupero della copia ${e}.`))}}));Promise.resolve()}else Promise.resolve()}))));yield Promise.all(t),window.alert("Copia/e vendute con successo."),yield I()}catch(e){e instanceof Error&&console.error(e.message)}}else window.alert("Seleziona almeno una copia da vendere.")}))})),i.ws.onopen=function(){console.log("aperto il server")},i.ws.onclose=function(){console.log("connessione server chiusa")},i.ws.onerror=function(e){console.log("errore nel webSocket",e)},r.D.onmessage=e=>c(void 0,void 0,void 0,(function*(){"Copie"===e.data.store&&(console.log("Aggiornamento ricevuto: ricarico copie..."),location.reload())})),document.addEventListener("DOMContentLoaded",(()=>c(void 0,void 0,void 0,(function*(){try{d=yield function(){let e=new Promise(((e,o)=>{const t=indexedDB.open("Database",1);t.onerror=()=>{o(t.onerror)},t.onsuccess=()=>{const o=t.result;e(o)}}));return e}(),console.log("Database aperto:",d.name),yield I(),null!=a&&function(){c(this,void 0,void 0,(function*(){try{null!=a&&(p=yield D(Number(a)),w.value=s.get("prezzoCopertina"),y.value=p.titolo,S())}catch(e){console.error("Venditore NON reperibile",e)}}))}()}catch(e){console.error(e)}}))))})();