(()=>{"use strict";class e{constructor(e,o,t,n){this.libroDellaCopiaISBN=e.isbn,this.codiceUnivoco=o,this.prezzoCopertina=t,this.prezzoScontato=parseFloat((.5*t).toFixed(2)),this.venditoreID=n.id}toString(){return`${this.libroDellaCopiaISBN};${this.codiceUnivoco};${this.prezzoCopertina};${this.prezzoScontato};${this.venditoreID}`}}const o=new BroadcastChannel("aggiornamentoDatabase"),t=new WebSocket("ws://localHost:8081");var n=function(e,o,t,n){return new(t||(t=Promise))((function(r,i){function c(e){try{s(n.next(e))}catch(e){i(e)}}function l(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var o;e.done?r(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(c,l)}s((n=n.apply(e,o||[])).next())}))};const r=new URLSearchParams(window.location.search),i=Number(r.get("venditoreID")),c=r.get("isbn");let l,s,a;const d=document.getElementById("aggiungiCopia");null==d||d.addEventListener("click",C);const u=document.getElementById("popupRegistraCopia"),p=document.getElementById("registraCopia");null==p||p.addEventListener("click",(function(){return n(this,void 0,void 0,(function*(){const t=yield function(){return n(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const t=l.transaction("Copie","readonly").objectStore("Copie").openCursor(null,"prev");t.onsuccess=()=>{const o=t.result;e(o?o.primaryKey:null)},t.onerror=()=>{o(t.error)}}))}))}();let i;if(i=null!==t?t+1:1,""!==g.value)if(null!=a){const t=new e(a,i,parseFloat(g.value),s);a=null,yield function(e){return n(this,void 0,void 0,(function*(){const t=l.transaction("Copie","readwrite").objectStore("Copie").add(e);t.onsuccess=()=>{g.value="",f.value="",r.delete("isbn"),r.delete("prezzoCopertina");const e=`${window.location.pathname}?${r.toString()}`;window.history.replaceState({},"",e),o.postMessage({store:"Copie"}),y(),b()},t.onerror=()=>{console.error("Copia già presente")}}))}(t)}else window.alert("Scegliere un libro dalla libreria da associarte alla copia che si vuole registrare");else window.alert("Inserire il prezzo di copertina per procedere con la registrazione")}))}));const m=document.getElementById("chiudiPopup");null==m||m.addEventListener("click",b);const v=document.getElementById("scegliLibro");null==v||v.addEventListener("click",(function(){const e=new URLSearchParams;e.set("venditoreID",String(s.id));const o=g.value;e.set("prezzoCopertina",o),window.location.href=`selezionaLibro.html?${e.toString()}`}));const g=document.getElementById("prezzoCopertina"),f=document.getElementById("titoloLibro"),h=document.getElementById("eliminaCopie");null==h||h.addEventListener("click",(function(){return n(this,void 0,void 0,(function*(){const e=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==e.length){if(window.confirm("Sei sicuro di voler eliminare le copie selezionate?"))try{const t=l.transaction(["Copie","CopieEliminate"],"readwrite"),r=t.objectStore("Copie"),i=t.objectStore("CopieEliminate"),c=Array.from(e).map((e=>n(this,void 0,void 0,(function*(){var t,n;const c=e.closest("tr");if(c){const e=null===(n=null===(t=c.cells[0])||void 0===t?void 0:t.textContent)||void 0===n?void 0:n.trim();if(e)return new Promise(((t,n)=>{const c=r.get(Number(e));c.onsuccess=()=>{const l=c.result;if(l){const c=i.add(l);c.onsuccess=()=>{r.delete(Number(e)),o.postMessage({store:"Copie"}),o.postMessage({store:"CopieEliminate"}),t()},c.onerror=()=>{n(new Error(`Errore nel salvataggio della copia ${e} nel cestino.`))}}else n(new Error(`Copia con ID ${e} non trovata.`))},c.onerror=()=>{n(new Error(`Errore nel recupero della copia ${e}.`))}}))}}))));yield Promise.all(c),window.alert("Copia/e eliminate logicamente."),yield y()}catch(e){e instanceof Error&&console.error(e.message)}}else window.alert("Seleziona almeno una copia da eliminare.")}))}));const w=document.getElementById("vendiCopie");function C(){null!=u&&(u.style.display="flex")}function b(){null!=u&&(u.style.display="none")}function y(){return n(this,void 0,void 0,(function*(){try{const e=yield function(){return n(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const t=l.transaction("Copie","readonly").objectStore("Copie").index("venditoreID").getAll(i);t.onsuccess=()=>{e(t.result)},t.onerror=()=>{o(t.error)}}))}))}();if(!i)throw new Error("ID venditore non valido");const o=l.transaction("Venditori","readonly").objectStore("Venditori");s=yield new Promise(((e,t)=>{const n=o.get(i);n.onsuccess=()=>{n.result?e(n.result):t(new Error("Venditore non trovato con ID: "+i))},n.onerror=e=>{console.error("Errore nella richiesta:",e),t(n.error)}}));const t=document.getElementById("corpoInfoVenditore");t.innerHTML="";const r=function(e){let o=0;for(let t=0;t<e.length;t++)o+=e[t].prezzoScontato;return Number(o.toFixed(2))}(e),c=document.createElement("tr");c.innerHTML=`<td>${s.id}</td><td>${s.nome}</td><td>${s.cognome}</td><td>${s.email}</td><td>${s.nTelefono}</td><td>${s.classe}</td><td>${r}</td>`,t.appendChild(c);const a=document.getElementById("corpoTabellaCopie");a.innerHTML="";for(let o=0;o<e.length;o++){let t=e[o];const n=yield new Promise(((e,o)=>{const n=l.transaction("Libri","readonly").objectStore("Libri").get(t.libroDellaCopiaISBN);n.onsuccess=()=>{n.result?e(n.result):o(new Error("Libro con ISBN non trovato"))},n.onerror=()=>{o(new Error("Database dei libri non reperibile"))}})),r=document.createElement("tr"),i=document.createElement("td"),c=document.createElement("input");c.setAttribute("type","checkbox"),c.setAttribute("class","caselleSelezione"),i.appendChild(c),r.appendChild(c);const s=document.createElement("td");s.textContent=String(t.codiceUnivoco),r.appendChild(s);const d=document.createElement("td");d.textContent=String(n.isbn),r.appendChild(d);const u=document.createElement("td");u.textContent=n.titolo,r.appendChild(u);const p=document.createElement("td");p.textContent=String(t.prezzoCopertina),r.appendChild(p);const m=document.createElement("td");m.textContent=String(t.prezzoScontato),r.appendChild(m),a.appendChild(r)}}catch(e){e instanceof Error&&console.error(e.message)}}))}function E(e){return n(this,void 0,void 0,(function*(){const o=l.transaction("Libri","readonly").objectStore("Libri");return yield new Promise(((t,n)=>{const r=o.get(e);r.onsuccess=()=>{r.result?t(r.result):n(new Error("Libro non trovato con ISBN"+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),n(r.error)}}))}))}null==w||w.addEventListener("click",(function(){return n(this,void 0,void 0,(function*(){const e=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==e.length){if(window.confirm("Sei sicuro di voler vendere le copie selezionate?"))try{const t=l.transaction(["Copie","CopieVendute"],"readwrite"),r=t.objectStore("Copie"),i=t.objectStore("CopieVendute"),c=Array.from(e).map((e=>n(this,void 0,void 0,(function*(){var t,n;const c=e.closest("tr");if(c){const e=null===(n=null===(t=c.cells[0])||void 0===t?void 0:t.textContent)||void 0===n?void 0:n.trim();if(e)return new Promise(((t,n)=>{const c=r.get(Number(e));c.onsuccess=()=>{const l=c.result;if(l){const c=i.add(l);c.onsuccess=()=>{r.delete(Number(e)),o.postMessage({store:"Copie"}),o.postMessage({store:"CopieVendute"}),t()},c.onerror=()=>{n(new Error(`Errore nella vendita della copia ${e}.`))}}else n(new Error(`Copia con ID ${e} non trovata.`))},c.onerror=()=>{n(new Error(`Errore nel recupero della copia ${e}.`))}}))}}))));yield Promise.all(c),window.alert("Copia/e eliminate logicamente."),yield y()}catch(e){e instanceof Error&&console.error(e.message)}}else window.alert("Seleziona almeno una copia da eliminare.")}))})),t.onopen=function(){console.log("aperto il server")},t.onclose=function(){console.log("connessione server chiusa")},t.onerror=function(e){console.log("errore nel webSocket",e)},t.onmessage=function(i){console.log(i.data);let c=i.data.split(",");"C"===c[0]&&0==Number(c[1])&&function(i){n(this,void 0,void 0,(function*(){try{const c=i.split(" ");console.log(c);const s=yield E(Number(c[0])),a=yield function(e){return n(this,void 0,void 0,(function*(){const o=l.transaction("Venditori","readonly").objectStore("Venditori"),t=yield new Promise(((t,n)=>{const r=o.get(e);r.onsuccess=()=>{r.result?t(r.result):n(new Error("Venditore non trovato con codice fiscale: "+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),n(r.error)}}));return t}))}(Number(c[4])),d=new e(s,Number(c[1]),Number(c[2]),a);yield function(e){return n(this,void 0,void 0,(function*(){const i=l.transaction("Venditori","readwrite").objectStore("Venditori").add(e);i.onsuccess=()=>n(this,void 0,void 0,(function*(){g.value="",f.value="",r.delete("isbn"),r.delete("prezzoCopertina");const n=`${window.location.pathname}?${r.toString()}`;var i;window.history.replaceState({},"",n),o.postMessage({store:"Venditori"}),i=e,t.send("C,0,"+String(i.toString())),y()})),i.onerror=()=>{console.log("Venditore già presente")}}))}(d)}catch(e){console.error("Errore nel recupero del libro mediante ISBN o del venditore mediante CF trasmesso da socket")}}))}(c[2])},o.onmessage=e=>n(void 0,void 0,void 0,(function*(){"Copie"===e.data.store&&(console.log("Aggiornamento ricevuto: ricarico copie..."),location.reload())})),document.addEventListener("DOMContentLoaded",(()=>n(void 0,void 0,void 0,(function*(){try{l=yield function(){let e=new Promise(((e,o)=>{const t=indexedDB.open("Database",1);t.onerror=()=>{o(t.onerror)},t.onsuccess=()=>{const o=t.result;e(o)}}));return e}(),console.log("Database aperto:",l.name),yield y(),null!=c&&function(){n(this,void 0,void 0,(function*(){try{null!=c&&(a=yield E(Number(c)),g.value=r.get("prezzoCopertina"),f.value=a.titolo,C())}catch(e){console.error("Venditore NON reperibile",e)}}))}()}catch(e){console.error(e)}}))))})();