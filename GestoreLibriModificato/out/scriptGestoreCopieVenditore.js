(()=>{"use strict";class e{constructor(e,o,t,n){this.libroDellaCopiaISBN=e.isbn,this.codiceUnivoco=o,this.prezzoCopertina=t,this.prezzoScontato=parseFloat((.5*t).toFixed(2)),this.venditoreID=n.id}toString(){return`${this.libroDellaCopiaISBN};${this.codiceUnivoco};${this.prezzoCopertina};${this.prezzoScontato};${this.venditoreID}`}}const o=new BroadcastChannel("aggiornamentoDatabase");var t=function(e,o,t,n){return new(t||(t=Promise))((function(r,i){function c(e){try{s(n.next(e))}catch(e){i(e)}}function l(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var o;e.done?r(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(c,l)}s((n=n.apply(e,o||[])).next())}))};const n=new URLSearchParams(window.location.search),r=Number(n.get("venditoreID")),i=n.get("isbn");let c,l,s;const a=document.getElementById("aggiungiCopia");null==a||a.addEventListener("click",C);const d=document.getElementById("popupRegistraCopia"),u=document.getElementById("registraCopia");null==u||u.addEventListener("click",(function(){return t(this,void 0,void 0,(function*(){const r=yield function(){return t(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const t=c.transaction("Copie","readonly").objectStore("Copie").openCursor(null,"prev");t.onsuccess=()=>{const o=t.result;e(o?o.primaryKey:null)},t.onerror=()=>{o(t.error)}}))}))}();let i;if(i=null!==r?r+1:1,""!==v.value)if(null!=s){const r=new e(s,i,parseFloat(v.value),l);s=null,yield function(e){return t(this,void 0,void 0,(function*(){const t=c.transaction("Copie","readwrite").objectStore("Copie").add(e);t.onsuccess=()=>{v.value="",g.value="",n.delete("isbn"),n.delete("prezzoCopertina");const e=`${window.location.pathname}?${n.toString()}`;window.history.replaceState({},"",e),o.postMessage({store:"Copie"}),y(),f()},t.onerror=()=>{console.error("Copia giÃ  presente")}}))}(r)}else window.alert("Scegliere un libro dalla libreria da associarte alla copia che si vuole registrare");else window.alert("Inserire il prezzo di copertina per procedere con la registrazione")}))}));const p=document.getElementById("chiudiPopup");null==p||p.addEventListener("click",f);const m=document.getElementById("scegliLibro");null==m||m.addEventListener("click",(function(){const e=new URLSearchParams;e.set("venditoreID",String(l.id));const o=v.value;e.set("prezzoCopertina",o),window.location.href=`selezionaLibro.html?${e.toString()}`}));const v=document.getElementById("prezzoCopertina"),g=document.getElementById("titoloLibro"),h=document.getElementById("eliminaCopie");function C(){null!=d&&(d.style.display="flex")}function f(){null!=d&&(d.style.display="none")}function y(){return t(this,void 0,void 0,(function*(){try{const e=yield function(){return t(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const t=c.transaction("Copie","readonly").objectStore("Copie").index("venditoreID").getAll(r);t.onsuccess=()=>{e(t.result)},t.onerror=()=>{o(t.error)}}))}))}();if(!r)throw new Error("ID venditore non valido");const o=c.transaction("Venditori","readonly").objectStore("Venditori");l=yield new Promise(((e,t)=>{const n=o.get(r);n.onsuccess=()=>{n.result?e(n.result):t(new Error("Venditore non trovato con ID: "+r))},n.onerror=e=>{console.error("Errore nella richiesta:",e),t(n.error)}}));const n=document.getElementById("corpoInfoVenditore");n.innerHTML="";const i=function(e){let o=0;for(let t=0;t<e.length;t++)o+=e[t].prezzoScontato;return Number(o.toFixed(2))}(e),s=document.createElement("tr");s.innerHTML=`<td>${l.id}</td><td>${l.nome}</td><td>${l.cognome}</td><td>${l.email}</td><td>${l.nTelefono}</td><td>${l.classe}</td><td>${i}</td>`,n.appendChild(s);const a=document.getElementById("corpoTabellaCopie");a.innerHTML="";for(let o=0;o<e.length;o++){let t=e[o];const n=yield new Promise(((e,o)=>{const n=c.transaction("Libri","readonly").objectStore("Libri").get(t.libroDellaCopiaISBN);n.onsuccess=()=>{n.result?e(n.result):o(new Error("Libro con ISBN non trovato"))},n.onerror=()=>{o(new Error("Database dei libri non reperibile"))}})),r=document.createElement("tr"),i=document.createElement("td"),l=document.createElement("input");l.setAttribute("type","checkbox"),l.setAttribute("class","caselleSelezione"),i.appendChild(l),r.appendChild(l);const s=document.createElement("td");s.textContent=String(t.codiceUnivoco),r.appendChild(s);const d=document.createElement("td");d.textContent=String(n.isbn),r.appendChild(d);const u=document.createElement("td");u.textContent=n.titolo,r.appendChild(u);const p=document.createElement("td");p.textContent=String(t.prezzoCopertina),r.appendChild(p);const m=document.createElement("td");m.textContent=String(t.prezzoCopertina),r.appendChild(m),a.appendChild(r)}}catch(e){e instanceof Error&&console.error(e.message)}}))}null==h||h.addEventListener("click",(function(){return t(this,void 0,void 0,(function*(){const e=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==e.length){if(window.confirm("Sei sicuro di voler eliminare le copie selezionate?"))try{const n=c.transaction(["Copie","CopieEliminate"],"readwrite"),r=n.objectStore("Copie"),i=n.objectStore("CopieEliminate"),l=Array.from(e).map((e=>t(this,void 0,void 0,(function*(){var t,n;const c=e.closest("tr");if(c){const e=null===(n=null===(t=c.cells[0])||void 0===t?void 0:t.textContent)||void 0===n?void 0:n.trim();if(e)return new Promise(((t,n)=>{const c=r.get(Number(e));c.onsuccess=()=>{const l=c.result;if(l){const c=i.add(l);c.onsuccess=()=>{r.delete(Number(e)),o.postMessage({store:"Copie"}),o.postMessage({store:"CopieEliminate"}),t()},c.onerror=()=>{n(new Error(`Errore nel salvataggio della copia ${e} nel cestino.`))}}else n(new Error(`Copia con ID ${e} non trovata.`))},c.onerror=()=>{n(new Error(`Errore nel recupero della copia ${e}.`))}}))}}))));yield Promise.all(l),window.alert("Copia/e eliminate logicamente."),yield y()}catch(e){e instanceof Error&&console.error(e.message)}}else window.alert("Seleziona almeno una copia da eliminare.")}))})),o.onmessage=e=>t(void 0,void 0,void 0,(function*(){"Copie"===e.data.store&&(console.log("Aggiornamento ricevuto: ricarico copie..."),yield y())})),document.addEventListener("DOMContentLoaded",(()=>t(void 0,void 0,void 0,(function*(){try{c=yield function(){let e=new Promise(((e,o)=>{const t=indexedDB.open("Database",1);t.onerror=()=>{o(t.onerror)},t.onsuccess=()=>{const o=t.result;e(o)}}));return e}(),console.log("Database aperto:",c.name),yield y(),null!=i&&function(){t(this,void 0,void 0,(function*(){try{null!=i&&(s=yield function(e){return t(this,void 0,void 0,(function*(){const o=c.transaction("Libri","readonly").objectStore("Libri");return yield new Promise(((t,n)=>{const r=o.get(e);r.onsuccess=()=>{r.result?t(r.result):n(new Error("Libro non trovato con ISBN"+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),n(r.error)}}))}))}(Number(i)),v.value=n.get("prezzoCopertina"),g.value=s.titolo,C())}catch(e){console.error("Venditore NON reperibile",e)}}))}()}catch(e){console.error(e)}}))))})();