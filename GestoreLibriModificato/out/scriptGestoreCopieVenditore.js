(()=>{"use strict";class e{constructor(e,o,t,n,r,i){this.libroDellaCopiaISBN=e.isbn,this.codiceUnivoco=o,this.prezzoCopertina=t,this.prezzoScontato=parseFloat((.5*t).toFixed(2)),this.venditoreID=n.id,this.stato=r,this.ultimaModifica=i}toString(){return`${this.libroDellaCopiaISBN};${this.codiceUnivoco};${this.prezzoCopertina};${this.prezzoScontato};${this.venditoreID};${this.stato};${this.ultimaModifica}`}}const o=new BroadcastChannel("aggiornamentoDatabase"),t=new WebSocket('wss://appsdev.marconivr.it/libraio/serverNode');var n=function(e,o,t,n){return new(t||(t=Promise))((function(r,i){function c(e){try{a(n.next(e))}catch(e){i(e)}}function l(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var o;e.done?r(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(c,l)}a((n=n.apply(e,o||[])).next())}))};const r=localStorage.getItem("contatoreMovimenti");let i=null!=r?Number(r):0,c=String(localStorage.getItem("passwordTentata")),l=document.getElementById("canvaBarcode");const a=new URLSearchParams(window.location.search),s=Number(a.get("venditoreID")),d=a.get("isbn");let u,m,p;const v=document.getElementById("aggiungiCopia");null==v||v.addEventListener("click",L);const g=document.getElementById("popupRegistraCopia"),f=document.getElementById("registraCopia");null==f||f.addEventListener("click",(function(){return n(this,void 0,void 0,(function*(){const t=yield function(){return n(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const t=u.transaction("Copie","readonly").objectStore("Copie").openCursor(null,"prev");t.onsuccess=()=>{const o=t.result;e(o?o.primaryKey:null)},t.onerror=()=>{o(t.error)}}))}))}();let r;if(r=null!==t?t+1:1,""!==y.value)if(null!=p){const t=new e(p,r,parseFloat(y.value),m,"D",(new Date).toLocaleString());p=null,yield function(e){return n(this,void 0,void 0,(function*(){i=Number(localStorage.getItem("contatoreMovimenti")),i++,localStorage.setItem("contatoreMovimenti",String(i));const t=u.transaction("Copie","readwrite").objectStore("Copie").add(e);t.onsuccess=()=>{y.value="",C.value="",a.delete("isbn"),a.delete("prezzoCopertina"),o.postMessage({store:"Copie"}),D(e),k(N(e.codiceUnivoco,m.id),`${e.codiceUnivoco}_copiaID`);const t=`${window.location.pathname}?${a.toString()}`;window.history.replaceState({},"",t),$(),B()},t.onerror=()=>{console.error("Copia giÃ  presente")}}))}(t)}else window.alert("Scegliere un libro dalla libreria da associarte alla copia che si vuole registrare");else window.alert("Inserire il prezzo di copertina per procedere con la registrazione")}))}));const h=document.getElementById("chiudiPopup");null==h||h.addEventListener("click",B);const w=document.getElementById("scegliLibro");null==w||w.addEventListener("click",(function(){const e=new URLSearchParams;e.set("venditoreID",String(m.id));const o=y.value;e.set("prezzoCopertina",o),window.location.href=`selezionaLibro.html?${e.toString()}`}));const y=document.getElementById("prezzoCopertina"),C=document.getElementById("titoloLibro"),E=document.getElementById("eliminaCopie");null==E||E.addEventListener("click",(function(){return n(this,void 0,void 0,(function*(){const e=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==e.length){if(window.confirm("Sei sicuro di voler eliminare le copie selezionate?"))try{const t=u.transaction("Copie","readwrite").objectStore("Copie"),r=Array.from(e).map((e=>n(this,void 0,void 0,(function*(){var n,r;const c=e.closest("tr");if(c){const e=null===(r=null===(n=c.cells[1])||void 0===n?void 0:n.textContent)||void 0===r?void 0:r.trim();if(e)return new Promise(((n,r)=>{const c=t.get(Number(e));c.onsuccess=()=>{const l=c.result;if(l){console.log("RIsultato prova eliminazione:"+l),l.stato="E",l.ultimaModifica=(new Date).toLocaleString();const c=t.put(l);c.onsuccess=()=>{i=Number(localStorage.getItem("contatoreMovimenti")),i++,localStorage.setItem("contatoreMovimenti",String(i)),o.postMessage({store:"Copie"}),D(l),n()},c.onerror=()=>{r(new Error(`Errore nell'aggiornamento della copia ${e}.`))}}else r(new Error(`Copia con ID ${e} non trovata.`))},c.onerror=()=>{r(new Error(`Errore nel recupero della copia ${e}.`))}}));Promise.resolve()}else Promise.resolve()}))));yield Promise.all(r),window.alert("Copia/e eliminate."),yield $()}catch(e){e instanceof Error&&console.error(e.message)}}else window.alert("Seleziona almeno una copia da eliminare.")}))}));const b=document.getElementById("aggiungiAlCarrello");null==b||b.addEventListener("click",(function(){return n(this,void 0,void 0,(function*(){const e=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==e.length)try{const t=u.transaction("Copie","readwrite").objectStore("Copie"),r=Array.from(e).map((e=>n(this,void 0,void 0,(function*(){var n,r;const i=e.closest("tr");if(i){const e=null===(r=null===(n=i.cells[1])||void 0===n?void 0:n.textContent)||void 0===r?void 0:r.trim();if(e)return new Promise(((n,r)=>{const i=t.get(Number(e));i.onsuccess=()=>{const c=i.result;if(c){c.stato="CAR",c.ultimaModifica=(new Date).toLocaleString();const i=t.put(c);i.onsuccess=()=>{o.postMessage({store:"Copie"}),D(c),n()},i.onerror=()=>{r(new Error(`Errore nell'aggiornamento della copia ${e}.`))}}else r(new Error(`Copia con ID ${e} non trovata.`))},i.onerror=()=>{r(new Error(`Errore nel recupero della copia ${e}.`))}}));Promise.resolve()}else Promise.resolve()}))));yield Promise.all(r),window.alert("Copia/e aggiunte al carrello con successo."),yield $()}catch(e){e instanceof Error&&console.error(e.message)}else window.alert("Seleziona almeno una copia da vendere.")}))}));const S=document.getElementById("ottieniBarcode");null==S||S.addEventListener("click",(function(){return n(this,void 0,void 0,(function*(){const e=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==e.length)try{const o=u.transaction("Copie","readwrite").objectStore("Copie"),t=Array.from(e).map((e=>n(this,void 0,void 0,(function*(){var t,n;const r=e.closest("tr");if(r){const e=null===(n=null===(t=r.cells[1])||void 0===t?void 0:t.textContent)||void 0===n?void 0:n.trim();if(e)return new Promise(((t,n)=>{const r=o.get(Number(e));r.onsuccess=()=>{const e=r.result;k(N(e.codiceUnivoco,m.id),`${e.codiceUnivoco}_copiaID`),t()},r.onerror=()=>{n(new Error(`Errore nel recupero della copia ${e}.`))}}));Promise.resolve()}else Promise.resolve()}))));yield Promise.all(t),window.alert("Download avviati!")}catch(e){e instanceof Error&&console.error(e.message)}}))}));const I=document.getElementById("apriCarrello");null==I||I.addEventListener("click",(()=>{window.open("carrello.html")}));const z=document.getElementById("vaiAllaRicevuta");function D(o){return n(this,void 0,void 0,(function*(){let r;if(o instanceof e)r=o;else{const t=o,i=yield x(Number(t.libroDellaCopiaISBN)),c=yield function(e){return n(this,void 0,void 0,(function*(){const o=u.transaction("Venditori","readonly").objectStore("Venditori");return yield new Promise(((t,n)=>{const r=o.get(e);r.onsuccess=()=>{r.result?t(r.result):n(new Error("Venditore non trovato con codice fiscale: "+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),n(r.error)}}))}))}(Number(t.venditoreID));r=new e(i,Number(t.codiceUnivoco),Number(t.prezzoCopertina),c,t.stato,t.ultimaModifica)}t.send("C-"+String(null==r?void 0:r.toString())+"-"+c)}))}function L(){null!=g&&(g.style.display="flex")}function B(){null!=g&&(g.style.display="none")}function $(){return n(this,void 0,void 0,(function*(){try{const e=yield function(){return n(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const t=u.transaction("Copie","readonly").objectStore("Copie").index("venditoreID").getAll(s);t.onsuccess=()=>{e(t.result)},t.onerror=()=>{o(t.error)}}))}))}();if(!s)throw new Error("ID venditore non valido");const o=u.transaction("Venditori","readonly").objectStore("Venditori");m=yield new Promise(((e,t)=>{const n=o.get(s);n.onsuccess=()=>{n.result?e(n.result):t(new Error("Venditore non trovato con ID: "+s))},n.onerror=e=>{console.error("Errore nella richiesta:",e),t(n.error)}}));const t=document.getElementById("corpoInfoVenditore");t.innerHTML="";const r=function(e){let o=0;for(let t=0;t<e.length;t++)"V"==e[t].stato&&(o+=e[t].prezzoScontato);return Number(o.toFixed(2))}(e),i=document.createElement("tr");i.innerHTML=`<td>${m.id}</td><td>${m.nome}</td><td>${m.cognome}</td><td>${m.email}</td><td>${m.nTelefono}</td><td>${m.classe}</td><td>${r}</td>`,t.appendChild(i);const c=document.getElementById("corpoTabellaCopie");c.innerHTML="";for(let o=0;o<e.length;o++){const t=e[o];if("E"!==t.stato){const e=yield new Promise(((e,o)=>{const n=u.transaction("Libri","readonly").objectStore("Libri").get(t.libroDellaCopiaISBN);n.onsuccess=()=>{n.result?e(n.result):o(new Error("Libro con ISBN non trovato"))},n.onerror=()=>{o(new Error("Database dei libri non reperibile"))}})),o=document.createElement("tr"),n=document.createElement("td");if("CAR"===t.stato){const e=document.createElement("span");e.classList.add("material-symbols-outlined"),e.textContent="shopping_cart",e.style.fontSize="40px",n.appendChild(e),o.appendChild(n)}else{const e=document.createElement("input");e.setAttribute("type","checkbox"),e.setAttribute("class","caselleSelezione"),"V"===t.stato&&(e.disabled=!0,o.classList.add("venduta")),n.appendChild(e),o.appendChild(n)}const r=document.createElement("td");r.textContent=String(t.codiceUnivoco),o.appendChild(r);const i=document.createElement("td");i.textContent=String(e.isbn),o.appendChild(i);const l=document.createElement("td");l.textContent=e.titolo,o.appendChild(l);const a=document.createElement("td");a.textContent=String(t.prezzoCopertina),o.appendChild(a);const s=document.createElement("td");s.textContent=String(t.prezzoScontato),o.appendChild(s),c.appendChild(o)}}}catch(e){e instanceof Error&&console.error(e.message)}}))}function P(e,o,t="0"){return e.toString().padStart(o,t)}function x(e){return n(this,void 0,void 0,(function*(){const o=u.transaction("Libri","readonly").objectStore("Libri");return yield new Promise(((t,n)=>{const r=o.get(e);r.onsuccess=()=>{r.result?t(r.result):n(new Error("Libro non trovato con ISBN"+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),n(r.error)}}))}))}function N(e,o){return l=document.createElement("canvas"),l.id="canvaBarcode",document.body.appendChild(l),JsBarcode(l,P(e,4),{format:"CODE128",width:2,text:P(o,4),height:100,displayValue:!0}),l.toDataURL("image/jpeg")}function k(e,o){const t=document.createElement("a");t.href=e,t.download=o,document.body.appendChild(t),t.click(),document.body.removeChild(t),l.remove()}null==z||z.addEventListener("click",(()=>{window.open(`../stampaRicevute/ricevutaDeposito.html?venditoreID=${m.id}`)})),t.onopen=function(){console.log("aperto il server")},t.onclose=function(){console.log("connessione server chiusa")},t.onerror=function(e){console.log("errore nel webSocket",e)},o.onmessage=e=>n(void 0,void 0,void 0,(function*(){"Copie"===e.data.store&&(console.log("Aggiornamento ricevuto: ricarico copie..."),yield $())})),document.addEventListener("DOMContentLoaded",(()=>n(void 0,void 0,void 0,(function*(){try{u=yield function(){let e=new Promise(((e,o)=>{const t=indexedDB.open("Database",1);t.onerror=()=>{o(t.onerror)},t.onsuccess=()=>{const o=t.result;e(o)}}));return e}(),console.log("Database aperto:",u.name),yield $(),null!=d&&function(){n(this,void 0,void 0,(function*(){try{null!=d&&(p=yield x(Number(d)),y.value=a.get("prezzoCopertina"),C.value=p.titolo,L())}catch(e){console.error("Venditore NON reperibile",e)}}))}()}catch(e){console.error(e)}}))))})();