(()=>{"use strict";class e{constructor(e,o,n,t,r){this.libroDellaCopiaISBN=e.isbn,this.codiceUnivoco=o,this.prezzoCopertina=n,this.prezzoScontato=parseFloat((.5*n).toFixed(2)),this.venditoreID=t.id,this.stato=r}toString(){return`${this.libroDellaCopiaISBN};${this.codiceUnivoco};${this.prezzoCopertina};${this.prezzoScontato};${this.venditoreID};${this.stato}`}}var o;!function(e){e.Disponibile="D",e.Venduta="V",e.Eliminata="E"}(o||(o={}));const n=new BroadcastChannel("aggiornamentoDatabase"),t=new WebSocket("ws://localHost:8081");t.onopen=function(){console.log("aperto il server")},t.onclose=function(){console.log("connessione server chiusa")},t.onerror=function(e){console.log("errore nel webSocket",e)};var r=function(e,o,n,t){return new(n||(n=Promise))((function(r,i){function c(e){try{l(t.next(e))}catch(e){i(e)}}function s(e){try{l(t.throw(e))}catch(e){i(e)}}function l(e){var o;e.done?r(e.value):(o=e.value,o instanceof n?o:new n((function(e){e(o)}))).then(c,s)}l((t=t.apply(e,o||[])).next())}))};const i=new URLSearchParams(window.location.search),c=Number(i.get("venditoreID")),s=i.get("isbn");let l,a,d;const u=document.getElementById("aggiungiCopia");null==u||u.addEventListener("click",E);const p=document.getElementById("popupRegistraCopia"),m=document.getElementById("registraCopia");null==m||m.addEventListener("click",(function(){return r(this,void 0,void 0,(function*(){const c=yield function(){return r(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const n=l.transaction("Copie","readonly").objectStore("Copie").openCursor(null,"prev");n.onsuccess=()=>{const o=n.result;e(o?o.primaryKey:null)},n.onerror=()=>{o(n.error)}}))}))}();let s;if(s=null!==c?c+1:1,""!==g.value)if(null!=d){const c=new e(d,s,parseFloat(g.value),a,o.Disponibile);d=null,yield function(e){return r(this,void 0,void 0,(function*(){const o=l.transaction("Copie","readwrite").objectStore("Copie").add(e);o.onsuccess=()=>{g.value="",h.value="",i.delete("isbn"),i.delete("prezzoCopertina"),n.postMessage({store:"Copie"}),function(e){t.send("C,"+String(e.toString()))}(e);const o=`${window.location.pathname}?${i.toString()}`;window.history.replaceState({},"",o),S(),b()},o.onerror=()=>{console.error("Copia già presente")}}))}(c)}else window.alert("Scegliere un libro dalla libreria da associarte alla copia che si vuole registrare");else window.alert("Inserire il prezzo di copertina per procedere con la registrazione")}))}));const v=document.getElementById("chiudiPopup");null==v||v.addEventListener("click",b);const f=document.getElementById("scegliLibro");null==f||f.addEventListener("click",(function(){const e=new URLSearchParams;e.set("venditoreID",String(a.id));const o=g.value;e.set("prezzoCopertina",o),window.location.href=`selezionaLibro.html?${e.toString()}`}));const g=document.getElementById("prezzoCopertina"),h=document.getElementById("titoloLibro"),w=document.getElementById("eliminaCopie");null==w||w.addEventListener("click",(function(){return r(this,void 0,void 0,(function*(){const e=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==e.length){if(window.confirm("Sei sicuro di voler eliminare le copie selezionate?"))try{const t=l.transaction("Copie","readwrite").objectStore("Copie"),i=Array.from(e).map((e=>r(this,void 0,void 0,(function*(){var r,i;const c=e.closest("tr");if(c){const e=null===(i=null===(r=c.cells[0])||void 0===r?void 0:r.textContent)||void 0===i?void 0:i.trim();if(e)return new Promise(((r,i)=>{const c=t.get(Number(e));c.onsuccess=()=>{const s=c.result;if(s){console.log("RIsultato prova eliminazione:"+s),s.stato=o.Eliminata;const c=t.put(s);c.onsuccess=()=>{n.postMessage({store:"Copie"}),r()},c.onerror=()=>{i(new Error(`Errore nell'aggiornamento della copia ${e}.`))}}else i(new Error(`Copia con ID ${e} non trovata.`))},c.onerror=()=>{i(new Error(`Errore nel recupero della copia ${e}.`))}}));Promise.resolve()}else Promise.resolve()}))));yield Promise.all(i),window.alert("Copia/e eliminate."),yield S()}catch(e){e instanceof Error&&console.error(e.message)}}else window.alert("Seleziona almeno una copia da eliminare.")}))}));const C=document.getElementById("vendiCopie");function y(e){switch(e){case"D":return o.Disponibile;case"V":return o.Venduta;case"E":return o.Eliminata;default:throw new Error(`Valore di stato non riconosciuto: ${e}`)}}function E(){null!=p&&(p.style.display="flex")}function b(){null!=p&&(p.style.display="none")}function S(){return r(this,void 0,void 0,(function*(){try{const e=yield function(){return r(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const n=l.transaction("Copie","readonly").objectStore("Copie").index("venditoreID").getAll(c);n.onsuccess=()=>{e(n.result)},n.onerror=()=>{o(n.error)}}))}))}();if(!c)throw new Error("ID venditore non valido");const n=l.transaction("Venditori","readonly").objectStore("Venditori");a=yield new Promise(((e,o)=>{const t=n.get(c);t.onsuccess=()=>{t.result?e(t.result):o(new Error("Venditore non trovato con ID: "+c))},t.onerror=e=>{console.error("Errore nella richiesta:",e),o(t.error)}}));const t=document.getElementById("corpoInfoVenditore");t.innerHTML="";const i=0,s=document.createElement("tr");s.innerHTML=`<td>${a.id}</td><td>${a.nome}</td><td>${a.cognome}</td><td>${a.email}</td><td>${a.nTelefono}</td><td>${a.classe}</td><td>${i}</td>`,t.appendChild(s);const d=document.getElementById("corpoTabellaCopie");d.innerHTML="";for(let n=0;n<e.length;n++){const t=e[n],r=y(t.stato);if(r===o.Eliminata)throw new Error("Errore confronto con enum");{const e=yield new Promise(((e,o)=>{const n=l.transaction("Libri","readonly").objectStore("Libri").get(t.libroDellaCopiaISBN);n.onsuccess=()=>{n.result?e(n.result):o(new Error("Libro con ISBN non trovato"))},n.onerror=()=>{o(new Error("Database dei libri non reperibile"))}})),n=document.createElement("tr"),i=document.createElement("td"),c=document.createElement("input");c.setAttribute("type","checkbox"),c.setAttribute("class","caselleSelezione"),r===o.Venduta&&(c.disabled=!0,n.classList.add("venduta")),i.appendChild(c),n.appendChild(i);const s=document.createElement("td");s.textContent=String(t.codiceUnivoco),n.appendChild(s);const a=document.createElement("td");a.textContent=String(e.isbn),n.appendChild(a);const u=document.createElement("td");u.textContent=e.titolo,n.appendChild(u);const p=document.createElement("td");p.textContent=String(t.prezzoCopertina),n.appendChild(p);const m=document.createElement("td");m.textContent=String(t.prezzoScontato),n.appendChild(m),d.appendChild(n)}}}catch(e){e instanceof Error&&console.error(e.message)}}))}function z(e){return r(this,void 0,void 0,(function*(){const o=l.transaction("Libri","readonly").objectStore("Libri");return yield new Promise(((n,t)=>{const r=o.get(e);r.onsuccess=()=>{r.result?n(r.result):t(new Error("Libro non trovato con ISBN"+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),t(r.error)}}))}))}null==C||C.addEventListener("click",(function(){return r(this,void 0,void 0,(function*(){const e=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==e.length){if(window.confirm("Sei sicuro di voler vendere le copie selezionate?"))try{const t=l.transaction("Copie","readwrite").objectStore("Copie"),i=Array.from(e).map((e=>r(this,void 0,void 0,(function*(){var r,i;const c=e.closest("tr");if(c){const e=null===(i=null===(r=c.cells[0])||void 0===r?void 0:r.textContent)||void 0===i?void 0:i.trim();if(e)return new Promise(((r,i)=>{const c=t.get(Number(e));c.onsuccess=()=>{const s=c.result;if(s){s.stato=o.Venduta;const c=t.put(s);c.onsuccess=()=>{n.postMessage({store:"Copie"}),n.postMessage({store:"Venditori"}),r()},c.onerror=()=>{i(new Error(`Errore nell'aggiornamento della copia ${e}.`))}}else i(new Error(`Copia con ID ${e} non trovata.`))},c.onerror=()=>{i(new Error(`Errore nel recupero della copia ${e}.`))}}));Promise.resolve()}else Promise.resolve()}))));yield Promise.all(i),window.alert("Copia/e vendute con successo."),yield S()}catch(e){e instanceof Error&&console.error(e.message)}}else window.alert("Seleziona almeno una copia da vendere.")}))})),t.onopen=function(){console.log("aperto il server")},t.onclose=function(){console.log("connessione server chiusa")},t.onerror=function(e){console.log("errore nel webSocket",e)},t.onmessage=function(o){console.log(o.data);let t=o.data.split(",");"C"===t[0]&&function(o){r(this,void 0,void 0,(function*(){try{const t=o.split(";");console.log(t);const c=y(t[4]),s=yield z(Number(t[0])),a=yield function(e){return r(this,void 0,void 0,(function*(){const o=l.transaction("Venditori","readonly").objectStore("Venditori"),n=yield new Promise(((n,t)=>{const r=o.get(e);r.onsuccess=()=>{r.result?n(r.result):t(new Error("Venditore non trovato con codice fiscale: "+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),t(r.error)}}));return n}))}(Number(t[4])),d=new e(s,Number(t[1]),Number(t[2]),a,c);console.log(d),yield function(e){return r(this,void 0,void 0,(function*(){const o=l.transaction("Copie","readwrite").objectStore("Copie").add(e);o.onsuccess=()=>r(this,void 0,void 0,(function*(){g.value="",h.value="",i.delete("isbn"),i.delete("prezzoCopertina"),n.postMessage({store:"Copie"});const e=`${window.location.pathname}?${i.toString()}`;window.history.replaceState({},"",e),yield S()})),o.onerror=()=>{console.log("Copia già presente")}}))}(d)}catch(e){console.error("Errore nel recupero del libro mediante ISBN o del venditore mediante CF trasmesso da socket")}}))}(t[1])},n.onmessage=e=>r(void 0,void 0,void 0,(function*(){"Copie"===e.data.store&&(console.log("Aggiornamento ricevuto: ricarico copie..."),location.reload())})),document.addEventListener("DOMContentLoaded",(()=>r(void 0,void 0,void 0,(function*(){try{l=yield function(){let e=new Promise(((e,o)=>{const n=indexedDB.open("Database",1);n.onerror=()=>{o(n.onerror)},n.onsuccess=()=>{const o=n.result;e(o)}}));return e}(),console.log("Database aperto:",l.name),yield S(),null!=s&&function(){r(this,void 0,void 0,(function*(){try{null!=s&&(d=yield z(Number(s)),g.value=i.get("prezzoCopertina"),h.value=d.titolo,E())}catch(e){console.error("Venditore NON reperibile",e)}}))}()}catch(e){console.error(e)}}))))})();