(()=>{"use strict";class e{constructor(e,o,t,n){this.libroDellaCopiaISBN=e.isbn,this.codiceUnivoco=o,this.prezzoCopertina=t,this.prezzoScontato=parseFloat((.5*t).toFixed(2)),this.venditoreID=n.id}toString(){return`${this.libroDellaCopiaISBN};${this.codiceUnivoco};${this.prezzoCopertina};${this.prezzoScontato};${this.venditoreID}`}}var o=function(e,o,t,n){return new(t||(t=Promise))((function(r,i){function c(e){try{s(n.next(e))}catch(e){i(e)}}function l(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var o;e.done?r(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(c,l)}s((n=n.apply(e,o||[])).next())}))};const t=new URLSearchParams(window.location.search),n=Number(t.get("venditoreID")),r=t.get("isbn");let i,c,l;const s=document.getElementById("aggiungiCopia");null==s||s.addEventListener("click",h);const d=document.getElementById("popupRegistraCopia"),a=document.getElementById("registraCopia");null==a||a.addEventListener("click",(function(){return o(this,void 0,void 0,(function*(){const t=yield function(){return o(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const t=i.transaction("Copie","readonly").objectStore("Copie").openCursor(null,"prev");t.onsuccess=()=>{const o=t.result;e(o?o.primaryKey:null)},t.onerror=()=>{o(t.error)}}))}))}();let n;if(n=null!==t?t+1:1,""!==v.value)if(null!=l){const t=new e(l,n,parseFloat(v.value),c);l=null,yield function(e){return o(this,void 0,void 0,(function*(){const o=i.transaction("Copie","readwrite").objectStore("Copie").add(e);o.onsuccess=()=>{g(),f()},o.onerror=()=>{console.error("Copia giÃ  presente")}}))}(t)}else window.alert("Scegliere un libro dalla libreria da associarte alla copia che si vuole registrare");else window.alert("Inserire il prezzo di copertina per procedere con la registrazione")}))}));const u=document.getElementById("chiudiPopup");null==u||u.addEventListener("click",f);const p=document.getElementById("scegliLibro");null==p||p.addEventListener("click",(function(){const e=new URLSearchParams;e.set("venditoreID",String(c.id));const o=v.value;e.set("prezzoCopertina",o),window.location.href=`selezionaLibro.html?${e.toString()}`}));const v=document.getElementById("prezzoCopertina"),m=document.getElementById("titoloLibro");function h(){null!=d&&(d.style.display="flex")}function f(){null!=d&&(d.style.display="none")}function g(){return o(this,void 0,void 0,(function*(){try{const e=yield function(){return o(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const t=i.transaction("Copie","readonly").objectStore("Copie").index("venditoreID");console.log(n);const r=t.getAll(n);r.onsuccess=()=>{e(r.result)},r.onerror=()=>{o(r.error)}}))}))}();if(!n)throw new Error("ID venditore non valido");const t=i.transaction("Venditori","readonly").objectStore("Venditori");c=yield new Promise(((e,o)=>{const r=t.get(n);r.onsuccess=()=>{r.result?e(r.result):o(new Error("Venditore non trovato con ID: "+n))},r.onerror=e=>{console.error("Errore nella richiesta:",e),o(r.error)}}));const r=document.getElementById("corpoInfoVenditore");r.innerHTML="";const l=function(e){let o=0;for(let t=0;t<e.length;t++)o+=e[t].prezzoScontato;return o}(e),s=document.createElement("tr");s.innerHTML=`<td>${c.id}</td><td>${c.nome}</td><td>${c.cognome}</td><td>${c.email}</td><td>${c.nTelefono}</td><td>${c.classe}</td><td>${l}</td>`,r.appendChild(s);const d=document.getElementById("corpoTabellaCopie");d.innerHTML="";for(let o=0;o<e.length;o++){let t=e[o];const n=yield new Promise(((e,o)=>{const n=i.transaction("Libri","readonly").objectStore("Libri").get(t.libroDellaCopiaISBN);n.onsuccess=()=>{n.result?e(n.result):o(new Error("Libro con ISBN non trovato"))},n.onerror=()=>{o(new Error("Database dei libri non reperibile"))}})),r=document.createElement("tr");r.innerHTML=`<td>${t.codiceUnivoco}</td>\n                            <td>${n.isbn}</td>\n                            <td>${n.titolo}</td>\n                            <td>${t.prezzoCopertina}</td>\n                            <td>${t.prezzoScontato}</td>`,d.appendChild(r)}}catch(e){e instanceof Error&&console.error(e.message)}}))}document.addEventListener("DOMContentLoaded",(()=>o(void 0,void 0,void 0,(function*(){try{i=yield function(){let e=new Promise(((e,o)=>{const t=indexedDB.open("Database",1);t.onerror=()=>{o(t.onerror)},t.onsuccess=()=>{const o=t.result;e(o)}}));return e}(),console.log("Database aperto:",i.name),yield g(),null!=r&&function(){o(this,void 0,void 0,(function*(){try{null!=r&&(l=yield function(e){return o(this,void 0,void 0,(function*(){const o=i.transaction("Libri","readonly").objectStore("Libri");return yield new Promise(((t,n)=>{const r=o.get(e);r.onsuccess=()=>{r.result?t(r.result):n(new Error("Libro non trovato con ISBN"+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),n(r.error)}}))}))}(Number(r)),v.value=t.get("prezzoCopertina"),m.value=l.titolo,h())}catch(e){console.error("Venditore NON reperibile",e)}}))}()}catch(e){console.error(e)}}))))})();