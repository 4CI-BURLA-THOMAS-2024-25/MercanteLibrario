(()=>{"use strict";class e{constructor(e,t,o,n){this.libroDellaCopiaISBN=e.isbn,this.codiceUnivoco=t,this.prezzoCopertina=o,this.prezzoScontato=parseFloat((.5*o).toFixed(2)),this.venditoreID=n.id}toString(){return`${this.libroDellaCopiaISBN};${this.codiceUnivoco};${this.prezzoCopertina};${this.prezzoScontato};${this.venditoreID}`}}var t=function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function c(e){try{a(n.next(e))}catch(e){i(e)}}function l(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(c,l)}a((n=n.apply(e,t||[])).next())}))};const o=new URLSearchParams(window.location.search),n=Number(o.get("venditoreID")),r=o.get("isbn");let i,c,l;const a=document.getElementById("aggiungiCopia");null==a||a.addEventListener("click",f);const s=document.getElementById("popupRegistraCopia"),d=document.getElementById("registraCopia");null==d||d.addEventListener("click",(function(){return t(this,void 0,void 0,(function*(){const n=yield function(){return t(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{const o=i.transaction("Copie","readonly").objectStore("Copie").openCursor(null,"prev");o.onsuccess=()=>{const t=o.result;e(t?t.primaryKey:null)},o.onerror=()=>{t(o.error)}}))}))}();let r;if(r=null!==n?n+1:1,""!==m.value)if(null!=l){const n=new e(l,r,parseFloat(m.value),c);l=null,yield function(e){return t(this,void 0,void 0,(function*(){const t=i.transaction("Copie","readwrite").objectStore("Copie").add(e);t.onsuccess=()=>{m.value="",v.value="",o.delete("isbn"),o.delete("prezzoCopertina");const e=`${window.location.pathname}?${o.toString()}`;window.history.replaceState({},"",e),C(),g()},t.onerror=()=>{console.error("Copia giÃ  presente")}}))}(n)}else window.alert("Scegliere un libro dalla libreria da associarte alla copia che si vuole registrare");else window.alert("Inserire il prezzo di copertina per procedere con la registrazione")}))}));const u=document.getElementById("chiudiPopup");null==u||u.addEventListener("click",g);const p=document.getElementById("scegliLibro");null==p||p.addEventListener("click",(function(){const e=new URLSearchParams;e.set("venditoreID",String(c.id));const t=m.value;e.set("prezzoCopertina",t),window.location.href=`selezionaLibro.html?${e.toString()}`}));const m=document.getElementById("prezzoCopertina"),v=document.getElementById("titoloLibro"),h=document.getElementById("eliminaCopie");function f(){null!=s&&(s.style.display="flex")}function g(){null!=s&&(s.style.display="none")}function C(){return t(this,void 0,void 0,(function*(){try{const e=yield function(){return t(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{const o=i.transaction("Copie","readonly").objectStore("Copie").index("venditoreID").getAll(n);o.onsuccess=()=>{e(o.result)},o.onerror=()=>{t(o.error)}}))}))}();if(!n)throw new Error("ID venditore non valido");const o=i.transaction("Venditori","readonly").objectStore("Venditori");c=yield new Promise(((e,t)=>{const r=o.get(n);r.onsuccess=()=>{r.result?e(r.result):t(new Error("Venditore non trovato con ID: "+n))},r.onerror=e=>{console.error("Errore nella richiesta:",e),t(r.error)}}));const r=document.getElementById("corpoInfoVenditore");r.innerHTML="";const l=function(e){let t=0;for(let o=0;o<e.length;o++)t+=e[o].prezzoScontato;return Number(t.toFixed(2))}(e),a=document.createElement("tr");a.innerHTML=`<td>${c.id}</td><td>${c.nome}</td><td>${c.cognome}</td><td>${c.email}</td><td>${c.nTelefono}</td><td>${c.classe}</td><td>${l}</td>`,r.appendChild(a);const s=document.getElementById("corpoTabellaCopie");s.innerHTML="";for(let t=0;t<e.length;t++){let o=e[t];const n=yield new Promise(((e,t)=>{const n=i.transaction("Libri","readonly").objectStore("Libri").get(o.libroDellaCopiaISBN);n.onsuccess=()=>{n.result?e(n.result):t(new Error("Libro con ISBN non trovato"))},n.onerror=()=>{t(new Error("Database dei libri non reperibile"))}})),r=document.createElement("tr"),c=document.createElement("td"),l=document.createElement("input");l.setAttribute("type","checkbox"),l.setAttribute("class","caselleSelezione"),c.appendChild(l),r.appendChild(l);const a=document.createElement("td");a.textContent=String(o.codiceUnivoco),r.appendChild(a);const d=document.createElement("td");d.textContent=String(n.isbn),r.appendChild(d);const u=document.createElement("td");u.textContent=n.titolo,r.appendChild(u);const p=document.createElement("td");p.textContent=String(o.prezzoCopertina),r.appendChild(p);const m=document.createElement("td");m.textContent=String(o.prezzoCopertina),r.appendChild(m),s.appendChild(r)}}catch(e){e instanceof Error&&console.error(e.message)}}))}null==h||h.addEventListener("click",(function(){return t(this,void 0,void 0,(function*(){const e=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==e.length){if(window.confirm("Sei sicuro di voler eliminare le copie selezionate?"))try{const o=i.transaction(["Copie","CopieEliminate"],"readwrite"),n=o.objectStore("Copie"),r=o.objectStore("CopieEliminate"),c=Array.from(e).map((e=>t(this,void 0,void 0,(function*(){var t,o;const i=e.closest("tr");if(i){const e=null===(o=null===(t=i.cells[0])||void 0===t?void 0:t.textContent)||void 0===o?void 0:o.trim();if(e)return new Promise(((t,o)=>{const i=n.get(Number(e));i.onsuccess=()=>{const c=i.result;if(c){const i=r.add(c);i.onsuccess=()=>{n.delete(Number(e)),t()},i.onerror=()=>{o(new Error(`Errore nel salvataggio della copia ${e} nel cestino.`))}}else o(new Error(`Copia con ID ${e} non trovata.`))},i.onerror=()=>{o(new Error(`Errore nel recupero della copia ${e}.`))}}))}}))));yield Promise.all(c),window.alert("Copia/e eliminate logicamente."),yield C()}catch(e){e instanceof Error&&console.error(e.message)}}else window.alert("Seleziona almeno una copia da eliminare.")}))})),document.addEventListener("DOMContentLoaded",(()=>t(void 0,void 0,void 0,(function*(){try{i=yield function(){let e=new Promise(((e,t)=>{const o=indexedDB.open("Database",1);o.onerror=()=>{t(o.onerror)},o.onsuccess=()=>{const t=o.result;e(t)}}));return e}(),console.log("Database aperto:",i.name),yield C(),null!=r&&function(){t(this,void 0,void 0,(function*(){try{null!=r&&(l=yield function(e){return t(this,void 0,void 0,(function*(){const t=i.transaction("Libri","readonly").objectStore("Libri");return yield new Promise(((o,n)=>{const r=t.get(e);r.onsuccess=()=>{r.result?o(r.result):n(new Error("Libro non trovato con ISBN"+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),n(r.error)}}))}))}(Number(r)),m.value=o.get("prezzoCopertina"),v.value=l.titolo,f())}catch(e){console.error("Venditore NON reperibile",e)}}))}()}catch(e){console.error(e)}}))))})();