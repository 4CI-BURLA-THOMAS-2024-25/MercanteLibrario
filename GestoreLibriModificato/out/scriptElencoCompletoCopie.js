(()=>{"use strict";const e=new BroadcastChannel("aggiornamentoDatabase");class o{constructor(e,o,n,t,r){this.libroDellaCopiaISBN=e.isbn,this.codiceUnivoco=o,this.prezzoCopertina=n,this.prezzoScontato=parseFloat((.5*n).toFixed(2)),this.venditoreID=t.id,this.stato=r}toString(){return`${this.libroDellaCopiaISBN};${this.codiceUnivoco};${this.prezzoCopertina};${this.prezzoScontato};${this.venditoreID};${this.stato}`}}const n=new WebSocket("ws://localHost:8081");n.onopen=function(){console.log("aperto il server")},n.onclose=function(){console.log("connessione server chiusa")},n.onerror=function(e){console.log("errore nel webSocket",e)};var t=function(e,o,n,t){return new(n||(n=Promise))((function(r,i){function c(e){try{l(t.next(e))}catch(e){i(e)}}function s(e){try{l(t.throw(e))}catch(e){i(e)}}function l(e){var o;e.done?r(e.value):(o=e.value,o instanceof n?o:new n((function(e){e(o)}))).then(c,s)}l((t=t.apply(e,o||[])).next())}))};let r;const i=document.getElementById("vendiCopie");function c(){return t(this,void 0,void 0,(function*(){try{const e=yield function(){return t(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const n=r.transaction("Copie","readonly").objectStore("Copie").getAll();n.onsuccess=()=>{e(n.result)},n.onerror=()=>{o(n.error)}}))}))}(),o=document.getElementById("corpoTabellaCopie");o.innerHTML="";for(let n=0;n<e.length;n++){const t=e[n];if("E"!==t.stato){const e=yield new Promise(((e,o)=>{const n=r.transaction("Libri","readonly").objectStore("Libri").get(t.libroDellaCopiaISBN);n.onsuccess=()=>{n.result?e(n.result):o(new Error("Libro con ISBN non trovato"))},n.onerror=()=>{o(new Error("Database dei libri non reperibile"))}})),n=document.createElement("tr"),i=document.createElement("td"),c=document.createElement("input");c.setAttribute("type","checkbox"),c.setAttribute("class","caselleSelezione"),"V"===t.stato&&(c.disabled=!0,n.classList.add("venduta")),i.appendChild(c),n.appendChild(i);const s=document.createElement("td");s.textContent=String(t.codiceUnivoco),n.appendChild(s);const l=document.createElement("td");l.textContent=String(e.isbn),n.appendChild(l);const a=document.createElement("td");a.textContent=e.titolo,n.appendChild(a);const d=document.createElement("td");d.textContent=String(t.prezzoCopertina),n.appendChild(d);const u=document.createElement("td");u.textContent=String(t.prezzoScontato),n.appendChild(u),o.appendChild(n)}}}catch(e){e instanceof Error&&console.error(e.message)}}))}null==i||i.addEventListener("click",(function(){return t(this,void 0,void 0,(function*(){const i=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==i.length){if(window.confirm("Sei sicuro di voler vendere le copie selezionate?"))try{const s=r.transaction("Copie","readwrite").objectStore("Copie"),l=Array.from(i).map((i=>t(this,void 0,void 0,(function*(){var c,l;const a=i.closest("tr");if(a){const i=null===(l=null===(c=a.cells[1])||void 0===c?void 0:c.textContent)||void 0===l?void 0:l.trim();if(i)return new Promise(((c,l)=>{const a=s.get(Number(i));a.onsuccess=()=>{const d=a.result;if(d){d.stato="V";const a=s.put(d);a.onsuccess=()=>{e.postMessage({store:"Copie"}),e.postMessage({store:"Venditori"}),function(e){t(this,void 0,void 0,(function*(){let i;if(e instanceof o)i=e;else{const n=e,c=yield function(e){return t(this,void 0,void 0,(function*(){const o=r.transaction("Libri","readonly").objectStore("Libri"),n=yield new Promise(((n,t)=>{const r=o.get(e);r.onsuccess=()=>{r.result?n(r.result):t(new Error("Libro non trovato con ISBN"+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),t(r.error)}}));return n}))}(Number(n.libroDellaCopiaISBN)),s=yield function(e){return t(this,void 0,void 0,(function*(){const o=r.transaction("Venditori","readonly").objectStore("Venditori"),n=yield new Promise(((n,t)=>{const r=o.get(e);r.onsuccess=()=>{r.result?n(r.result):t(new Error("Venditore non trovato con codice fiscale: "+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),t(r.error)}}));return n}))}(Number(n.venditoreID));i=new o(c,Number(n.codiceUnivoco),Number(n.prezzoCopertina),s,n.stato)}n.send("C,"+String(null==i?void 0:i.toString()))}))}(d),c()},a.onerror=()=>{l(new Error(`Errore nell'aggiornamento della copia ${i}.`))}}else l(new Error(`Copia con ID ${i} non trovata.`))},a.onerror=()=>{l(new Error(`Errore nel recupero della copia ${i}.`))}}));Promise.resolve()}else Promise.resolve()}))));yield Promise.all(l),window.alert("Copia/e vendute con successo."),yield c()}catch(e){e instanceof Error&&console.error(e.message)}}else window.alert("Seleziona almeno una copia da vendere.")}))})),n.onopen=function(){console.log("aperto il server")},n.onclose=function(){console.log("connessione server chiusa")},n.onerror=function(e){console.log("errore nel webSocket",e)},e.onmessage=e=>t(void 0,void 0,void 0,(function*(){"Copie"===e.data.store&&(console.log("Aggiornamento ricevuto: ricarico copie..."),location.reload())})),document.addEventListener("DOMContentLoaded",(()=>t(void 0,void 0,void 0,(function*(){try{r=yield function(){let e=new Promise(((e,o)=>{const n=indexedDB.open("Database",1);n.onerror=()=>{o(n.onerror)},n.onsuccess=()=>{const o=n.result;e(o)}}));return e}(),console.log("Database aperto:",r.name),yield c()}catch(e){console.error(e)}}))))})();