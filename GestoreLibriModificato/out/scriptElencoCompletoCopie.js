(()=>{"use strict";const e=new BroadcastChannel("aggiornamentoDatabase");class o{constructor(e,o,t,n,r,i){this.libroDellaCopiaISBN=e.isbn,this.codiceUnivoco=o,this.prezzoCopertina=t,this.prezzoScontato=parseFloat((.5*t).toFixed(2)),this.venditoreID=n.id,this.stato=r,this.ultimaModifica=i}toString(){return`${this.libroDellaCopiaISBN};${this.codiceUnivoco};${this.prezzoCopertina};${this.prezzoScontato};${this.venditoreID};${this.stato};${this.ultimaModifica}`}}const t=new WebSocket("ws://localHost:8081");var n=function(e,o,t,n){return new(t||(t=Promise))((function(r,i){function c(e){try{a(n.next(e))}catch(e){i(e)}}function l(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var o;e.done?r(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(c,l)}a((n=n.apply(e,o||[])).next())}))};let r,i=document.getElementById("canvaBarcode");const c=document.getElementById("aggiungiAlCarrello");null==c||c.addEventListener("click",(function(){return n(this,void 0,void 0,(function*(){const o=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==o.length)try{const t=r.transaction("Copie","readwrite").objectStore("Copie"),i=Array.from(o).map((o=>n(this,void 0,void 0,(function*(){var n,r;const i=o.closest("tr");if(i){const o=null===(r=null===(n=i.cells[1])||void 0===n?void 0:n.textContent)||void 0===r?void 0:r.trim();if(o)return new Promise(((n,r)=>{const i=t.get(Number(o));i.onsuccess=()=>{const c=i.result;if(c){c.stato="CAR",c.ultimaModifica=(new Date).toLocaleString();const i=t.put(c);i.onsuccess=()=>{e.postMessage({store:"Copie"}),f(c),n()},i.onerror=()=>{r(new Error(`Errore nell'aggiornamento della copia ${o}.`))}}else r(new Error(`Copia con ID ${o} non trovata.`))},i.onerror=()=>{r(new Error(`Errore nel recupero della copia ${o}.`))}}));Promise.resolve()}else Promise.resolve()}))));yield Promise.all(i),window.alert("Copia/e aggiunte al carrello con successo."),yield h()}catch(e){e instanceof Error&&console.error(e.message)}else window.alert("Seleziona almeno una copia da vendere.")}))}));const l=document.getElementById("ottieniBarcode");null==l||l.addEventListener("click",(function(){return n(this,void 0,void 0,(function*(){const e=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==e.length)try{const o=r.transaction("Copie","readwrite").objectStore("Copie"),t=Array.from(e).map((e=>n(this,void 0,void 0,(function*(){var t,n;const r=e.closest("tr");if(r){const e=null===(n=null===(t=r.cells[1])||void 0===t?void 0:t.textContent)||void 0===n?void 0:n.trim();if(e)return new Promise(((t,n)=>{const r=o.get(Number(e));r.onsuccess=()=>{const e=r.result;var o,n;!function(e,o){const t=document.createElement("a");t.href=e,t.download=o,document.body.appendChild(t),t.click(),document.body.removeChild(t),i.remove()}((o=e.codiceUnivoco,n=e.venditoreID,i=document.createElement("canvas"),i.id="canvaBarcode",document.body.appendChild(i),JsBarcode(i,C(o,4),{format:"CODE128",width:2,text:C(n,4),height:100,displayValue:!0}),i.toDataURL("image/jpeg")),`${e.codiceUnivoco}_copiaID`),t()},r.onerror=()=>{n(new Error(`Errore nel recupero della copia ${e}.`))}}));Promise.resolve()}else Promise.resolve()}))));yield Promise.all(t),window.alert("Download avviati!")}catch(e){e instanceof Error&&console.error(e.message)}else window.alert("Seleziona le copie di cui vuoi scaricare il barcode")}))}));const a=document.getElementById("barcodeVendita");null==a||a.addEventListener("click",(function(){null!=s&&(s.style.display="flex",d.focus())}));const s=document.getElementById("popupScansionaBarcode"),d=document.getElementById("barcodeLetto");null==d||d.addEventListener("keydown",(o=>function(o){return n(this,void 0,void 0,(function*(){if("Enter"===o.key)try{const o=d.value,t=yield function(e){return n(this,void 0,void 0,(function*(){const o=r.transaction("Copie","readwrite").objectStore("Copie");return yield new Promise(((t,n)=>{const r=o.get(e);r.onsuccess=()=>{r.result?t(r.result):n(window.alert("Copia non trovata"))},r.onerror=()=>{n(new Error("Errore nella richiesta"))}}))}))}(Number(o));if("V"===t.stato)window.alert("Copia già venduta!");else if("CAR"===t.stato)window.alert("Copia già nel carrello!");else{const o=yield g(t.libroDellaCopiaISBN);u.value=String(t.prezzoCopertina),p.value=o.titolo,t.stato="CAR",t.ultimaModifica=(new Date).toLocaleString(),yield function(o){return n(this,void 0,void 0,(function*(){const t=r.transaction("Copie","readwrite").objectStore("Copie").put(o);t.onsuccess=()=>{e.postMessage({store:"Copie"}),e.postMessage({store:"Venditori"}),f(o)},t.onerror=()=>{throw new Error("Impossibile aggiornare lo stato della copia")}}))}(t),yield h()}}catch(e){e instanceof Error&&console.error(e.message)}finally{d.value=""}}))}(o)));const u=document.getElementById("prezzoCopertinaBarcode"),p=document.getElementById("titoloLibroBarcode"),m=document.getElementById("chiudiPopupBarcode");null==m||m.addEventListener("click",(function(){null!=s&&(d.value="",u.value="",p.value="",s.style.display="none")}));const v=document.getElementById("apriCarrello");function f(e){return n(this,void 0,void 0,(function*(){let i;if(e instanceof o)i=e;else{const t=e,c=yield g(Number(t.libroDellaCopiaISBN)),l=yield function(e){return n(this,void 0,void 0,(function*(){const o=r.transaction("Venditori","readonly").objectStore("Venditori");return yield new Promise(((t,n)=>{const r=o.get(e);r.onsuccess=()=>{r.result?t(r.result):n(new Error("Venditore non trovato con codice fiscale: "+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),n(r.error)}}))}))}(Number(t.venditoreID));i=new o(c,Number(t.codiceUnivoco),Number(t.prezzoCopertina),l,t.stato,t.ultimaModifica)}t.send("C-"+String(null==i?void 0:i.toString()))}))}function h(){return n(this,void 0,void 0,(function*(){try{const e=yield function(){return n(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const t=r.transaction("Copie","readonly").objectStore("Copie").getAll();t.onsuccess=()=>{e(t.result)},t.onerror=()=>{o(t.error)}}))}))}(),o=document.getElementById("corpoTabellaCopie");o.innerHTML="";for(let t=0;t<e.length;t++){const n=e[t];if("E"!==n.stato){const e=yield new Promise(((e,o)=>{const t=r.transaction("Libri","readonly").objectStore("Libri").get(n.libroDellaCopiaISBN);t.onsuccess=()=>{t.result?e(t.result):o(new Error("Libro con ISBN non trovato"))},t.onerror=()=>{o(new Error("Database dei libri non reperibile"))}})),t=document.createElement("tr"),i=document.createElement("td");if("CAR"===n.stato){const e=document.createElement("img");e.src="../img/carrello.png",e.setAttribute("class","nelCarrello"),i.appendChild(e),t.appendChild(i)}else{const e=document.createElement("input");e.setAttribute("type","checkbox"),e.setAttribute("class","caselleSelezione"),"V"===n.stato&&(e.disabled=!0,t.classList.add("venduta")),i.appendChild(e),t.appendChild(i)}const c=document.createElement("td");c.textContent=String(n.codiceUnivoco),t.appendChild(c);const l=document.createElement("td");l.textContent=String(e.isbn),t.appendChild(l);const a=document.createElement("td");a.textContent=e.titolo,t.appendChild(a);const s=document.createElement("td");s.textContent=String(n.prezzoCopertina),t.appendChild(s);const d=document.createElement("td");d.textContent=String(n.prezzoScontato),t.appendChild(d),o.appendChild(t)}}}catch(e){e instanceof Error&&console.error(e.message)}}))}function g(e){return n(this,void 0,void 0,(function*(){const o=r.transaction("Libri","readonly").objectStore("Libri");return yield new Promise(((t,n)=>{const r=o.get(e);r.onsuccess=()=>{r.result?t(r.result):n(new Error("Libro non trovato con ISBN"+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),n(r.error)}}))}))}function C(e,o,t="0"){return e.toString().padStart(o,t)}null==v||v.addEventListener("click",(()=>{window.open("carrello.html")})),t.onopen=function(){console.log("aperto il server")},t.onclose=function(){console.log("connessione server chiusa")},t.onerror=function(e){console.log("errore nel webSocket",e)},e.onmessage=e=>n(void 0,void 0,void 0,(function*(){"Copie"===e.data.store&&(console.log("Aggiornamento ricevuto: ricarico copie..."),yield h())})),document.addEventListener("DOMContentLoaded",(()=>n(void 0,void 0,void 0,(function*(){try{r=yield function(){let e=new Promise(((e,o)=>{const t=indexedDB.open("Database",1);t.onerror=()=>{o(t.onerror)},t.onsuccess=()=>{const o=t.result;e(o)}}));return e}(),console.log("Database aperto:",r.name),yield h()}catch(e){console.error(e)}}))))})();