(()=>{"use strict";var e;!function(e){e.Disponibile="D",e.Venduta="V",e.Eliminata="E"}(e||(e={}));const t=new BroadcastChannel("aggiornamentoDatabase");var o=function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function c(e){try{l(n.next(e))}catch(e){i(e)}}function a(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(c,a)}l((n=n.apply(e,t||[])).next())}))};let n;const r=document.getElementById("annullaVendita");function i(){return o(this,void 0,void 0,(function*(){try{const t=yield function(){return o(this,void 0,void 0,(function*(){return new Promise(((t,o)=>{const r=n.transaction("Copie","readonly").objectStore("Copie").getAll();r.onsuccess=()=>{const o=r.result.filter((t=>t.stato===e.Venduta));t(o)},r.onerror=()=>{o(r.error)}}))}))}(),r=document.getElementById("corpoTabellaCopie");r.innerHTML="";for(let e=0;e<t.length;e++){let o=t[e];const i=yield new Promise(((e,t)=>{const r=n.transaction("Libri","readonly").objectStore("Libri").get(o.libroDellaCopiaISBN);r.onsuccess=()=>{r.result?e(r.result):t(new Error("Libro con ISBN non trovato"))},r.onerror=()=>{t(new Error("Database dei libri non reperibile"))}})),c=document.createElement("tr"),a=document.createElement("td"),l=document.createElement("input");l.setAttribute("type","checkbox"),l.setAttribute("class","caselleSelezione"),a.appendChild(l),c.appendChild(l);const s=document.createElement("td");s.textContent=String(o.codiceUnivoco),c.appendChild(s);const d=document.createElement("td");d.textContent=String(i.isbn),c.appendChild(d);const u=document.createElement("td");u.textContent=i.titolo,c.appendChild(u);const p=document.createElement("td");p.textContent=String(o.prezzoCopertina),c.appendChild(p);const m=document.createElement("td");m.textContent=String(o.prezzoScontato),c.appendChild(m),r.appendChild(c)}}catch(e){e instanceof Error&&console.error(e.message)}}))}null==r||r.addEventListener("click",(function(){return o(this,void 0,void 0,(function*(){const r=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==r.length){if(window.confirm("Vuoi ripristinare le copie selezionate?"))try{const c=n.transaction("Copie","readwrite").objectStore("Copie"),a=Array.from(r).map((n=>o(this,void 0,void 0,(function*(){var o,r;const i=n.closest("tr");if(i){const n=null===(r=null===(o=i.cells[0])||void 0===o?void 0:o.textContent)||void 0===r?void 0:r.trim();if(n)return new Promise(((o,r)=>{const i=c.get(Number(n));i.onsuccess=()=>{const a=i.result;if(a){a.stato=e.Disponibile;const n=c.put(a);n.onsuccess=()=>{t.postMessage({store:"Copie"}),t.postMessage({store:"Venditori"}),o()},n.onerror=()=>{r(new Error("Errore nell'aggiornamento dello stato della copia."))}}else r(new Error(`Copia con ID ${n} non trovata nello store 'Copie'.`))},i.onerror=()=>{r(new Error("Errore nel recupero della copia."))}}))}}))));yield Promise.all(a),window.alert("Copia/e ripristinate correttamente."),yield i()}catch(e){e instanceof Error&&console.log(e.message)}}else window.alert("Seleziona almeno una copia da ripristinare")}))})),t.onmessage=e=>o(void 0,void 0,void 0,(function*(){"Copie"===e.data.store&&(console.log("Aggiornamento ricevuto: ricarico copie vendute..."),location.reload())})),document.addEventListener("DOMContentLoaded",(()=>o(void 0,void 0,void 0,(function*(){try{n=yield function(){let e=new Promise(((e,t)=>{const o=indexedDB.open("Database",1);o.onerror=()=>{t(o.onerror)},o.onsuccess=()=>{const t=o.result;e(t)}}));return e}(),console.log("Database aperto:",n.name),yield i()}catch(e){console.error(e)}}))))})();