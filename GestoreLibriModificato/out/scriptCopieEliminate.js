(()=>{"use strict";class e{constructor(e,o,t,n,r,i){this.libroDellaCopiaISBN=e.isbn,this.codiceUnivoco=o,this.prezzoCopertina=t,this.prezzoScontato=parseFloat((.5*t).toFixed(2)),this.venditoreID=n.id,this.stato=r,this.ultimaModifica=i}toString(){return`${this.libroDellaCopiaISBN};${this.codiceUnivoco};${this.prezzoCopertina};${this.prezzoScontato};${this.venditoreID};${this.stato};${this.ultimaModifica}`}}const o=new BroadcastChannel("aggiornamentoDatabase"),t=new WebSocket('wss://appsdev.marconivr.it/libraio/serverNode');var n=function(e,o,t,n){return new(t||(t=Promise))((function(r,i){function c(e){try{a(n.next(e))}catch(e){i(e)}}function s(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var o;e.done?r(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(c,s)}a((n=n.apply(e,o||[])).next())}))};let r;const i=document.getElementById("ripristinaCopie");null==i||i.addEventListener("click",(function(){return n(this,void 0,void 0,(function*(){const i=document.querySelectorAll('input[type="checkbox"].caselleSelezione:checked');if(0!==i.length){if(window.confirm("Vuoi ripristinare le copie selezionate?"))try{const a=r.transaction("Copie","readwrite").objectStore("Copie"),l=Array.from(i).map((i=>n(this,void 0,void 0,(function*(){var s,l;const d=i.closest("tr");if(d){const i=null===(l=null===(s=d.cells[0])||void 0===s?void 0:s.textContent)||void 0===l?void 0:l.trim();if(i)return new Promise(((s,l)=>{const d=a.get(Number(i));d.onsuccess=()=>{const u=d.result;if(u){u.stato="D",u.ultimaModifica=(new Date).toLocaleString();const i=a.put(u);i.onsuccess=()=>{o.postMessage({store:"Copie"}),function(o){n(this,void 0,void 0,(function*(){let i;if(o instanceof e)i=o;else{const t=o,c=yield function(e){return n(this,void 0,void 0,(function*(){const o=r.transaction("Libri","readonly").objectStore("Libri"),t=yield new Promise(((t,n)=>{const r=o.get(e);r.onsuccess=()=>{r.result?t(r.result):n(new Error("Libro non trovato con ISBN"+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),n(r.error)}}));return t}))}(Number(t.libroDellaCopiaISBN)),s=yield function(e){return n(this,void 0,void 0,(function*(){const o=r.transaction("Venditori","readonly").objectStore("Venditori"),t=yield new Promise(((t,n)=>{const r=o.get(e);r.onsuccess=()=>{r.result?t(r.result):n(new Error("Venditore non trovato con codice fiscale: "+e))},r.onerror=e=>{console.error("Errore nella richiesta:",e),n(r.error)}}));return t}))}(Number(t.venditoreID));i=new e(c,Number(t.codiceUnivoco),Number(t.prezzoCopertina),s,t.stato,t.ultimaModifica)}t.send("C-"+String(null==i?void 0:i.toString())+"-"+c)}))}(u),s()},i.onerror=()=>{l(new Error("Errore nell'aggiornamento dello stato della copia."))}}else l(new Error(`Copia con ID ${i} non trovata nello store 'Copie'.`))},d.onerror=()=>{l(new Error("Errore nel recupero della copia."))}}))}}))));yield Promise.all(l),window.alert("Copia/e ripristinate correttamente."),yield s()}catch(e){e instanceof Error&&console.error(e.message)}}else window.alert("Seleziona almeno una copia da ripristinare")}))}));let c=String(localStorage.getItem("passwordTentata"));function s(){return n(this,void 0,void 0,(function*(){try{const e=yield function(){return n(this,void 0,void 0,(function*(){return new Promise(((e,o)=>{const t=r.transaction("Copie","readonly").objectStore("Copie").getAll();t.onsuccess=()=>{const o=t.result.filter((e=>"E"===e.stato));e(o)},t.onerror=()=>{o(t.error)}}))}))}(),o=document.getElementById("corpoTabellaCopie");o.innerHTML="";for(let t=0;t<e.length;t++){let n=e[t];const i=yield new Promise(((e,o)=>{const t=r.transaction("Libri","readonly").objectStore("Libri").get(n.libroDellaCopiaISBN);t.onsuccess=()=>{t.result?e(t.result):o(new Error("Libro con ISBN non trovato"))},t.onerror=()=>{o(new Error("Database dei libri non reperibile"))}})),c=document.createElement("tr"),s=document.createElement("td"),a=document.createElement("input");a.setAttribute("type","checkbox"),a.setAttribute("class","caselleSelezione"),s.appendChild(a),c.appendChild(a);const l=document.createElement("td");l.textContent=String(n.codiceUnivoco),c.appendChild(l);const d=document.createElement("td");d.textContent=String(i.isbn),c.appendChild(d);const u=document.createElement("td");u.textContent=i.titolo,c.appendChild(u);const p=document.createElement("td");p.textContent=String(n.prezzoCopertina),c.appendChild(p);const m=document.createElement("td");m.textContent=String(n.prezzoScontato),c.appendChild(m),o.appendChild(c)}}catch(e){e instanceof Error&&console.error(e.message)}}))}t.onopen=function(){console.log("aperto il server")},t.onclose=function(){console.log("connessione server chiusa")},t.onerror=function(e){console.log("errore nel webSocket",e)},o.onmessage=e=>n(void 0,void 0,void 0,(function*(){"Copie"===e.data.store&&(console.log("Aggiornamento ricevuto: ricarico copie eliminate..."),yield s())})),document.addEventListener("DOMContentLoaded",(()=>n(void 0,void 0,void 0,(function*(){try{r=yield function(){let e=new Promise(((e,o)=>{const t=indexedDB.open("Database",1);t.onerror=()=>{o(t.onerror)},t.onsuccess=()=>{const o=t.result;e(o)}}));return e}(),console.log("Database aperto:",r.name),yield s()}catch(e){console.error(e)}}))))})();